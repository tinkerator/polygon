package polygon

import (
	"fmt"
	"math"
	"testing"
)

// validate that the bounding box for a polygon is correct.
func (p *Shapes) chk(n int) error {
	p1 := p.P[n]
	var ll, tr Point
	for i, pt := range p1.PS {
		if i == 0 {
			ll = pt
			tr = pt
			continue
		}
		if pt.X < ll.X {
			ll.X = pt.X
		} else if pt.X > tr.X {
			tr.X = pt.X
		}
		if pt.Y < ll.Y {
			ll.Y = pt.Y
		} else if pt.Y > tr.Y {
			tr.Y = pt.Y
		}
	}
	if math.Abs(ll.X-p1.MinX) > Zeroish || math.Abs(ll.Y-p1.MinY) > Zeroish || math.Abs(tr.X-p1.MaxX) > Zeroish || math.Abs(tr.Y-p1.MaxY) > Zeroish {
		return fmt.Errorf("bad bounding box [%d]: %#v - vs %v %v", n, p1, ll, tr)
	}
	return nil
}

func TestIsLeft(t *testing.T) {
	vs := []struct {
		a, b, c Point
		want    bool
	}{
		{Point{0, .1}, Point{0, 0}, Point{1, 0}, true},
		{Point{.1, 0}, Point{0, 0}, Point{0, 1}, false},
	}
	for i, v := range vs {
		got := v.a.isLeft(v.b, v.c)
		if got != v.want {
			t.Fatalf("test=%d error see %v is left=%v of %v->%v", i, v.a, v.want, v.b, v.c)
		}
	}
}

func TestMinMax(t *testing.T) {
	vs := []struct{ x, y, a, b float64 }{
		{x: 1, y: 2, a: 1, b: 2},
		{x: 2, y: 1, a: 1, b: 2},
		{x: -1, y: -2, a: -2, b: -1},
		{x: -1, y: 1, a: -1, b: 1},
	}
	for i, v := range vs {
		a, b := MinMax(v.x, v.y)
		if a != v.a || b != v.b {
			t.Errorf("test=%d MinMax(%f,%f) failed: got a=%f, b=%f, wanted a=%f, b=%f", i, v.x, v.y, a, b, v.a, v.b)
		}
	}
}

func TestInside(t *testing.T) {
	var s *Shapes

	s = nil
	s = s.Builder([]Point{
		{1, 1}, {9, 1}, {9, 5}, {8, 5}, {6, 4},
	}...)
	if pt := (Point{1, 5}); pt.Inside(s.P[0]) {
		t.Errorf("point %v should not be inside shape", pt)
	}

	s = nil
	s = s.Builder([]Point{
		{-3.8181818182, 12.2727272727},
		{-0.2727272727, 12.2727272727},
		{-0.2727272727, 1.0909090909},
		{0.2727272727, 1.0909090909},
		{0.2727272727, 12.2727272727},
		{3.8181818182, 12.2727272727},
		{3.8181818182, 12.8181818182},
		{-3.8181818182, 12.8181818182},
	}...)
	pt := Point{0, 12.2727272727}
	if !pt.Inside(s.P[0]) {
		t.Errorf("point %v should be inside shape", pt)
	}

	s = nil
	s = s.Builder([]Point{
		{0, 0},
		{2, 1},
		{3, 1},
		{0, 2},
	}...)
	pt = Point{1, 1}
	if !pt.Inside(s.P[0]) {
		t.Errorf("point %v should be inside shape", pt)
	}

	s = nil
	s = s.Builder([]Point{
		{102.02893679864614, 75.27038988683911},
		{102.0529527410619, 75.17135781555598},
		{102.11738387113262, 75.07488387113261},
		{102.21385781555601, 75.0104527410619},
		{102.31288988683914, 74.98643679864615},
		{107.93229226724219, 77.30370017967351},
		{107.77428982006037, 77.2758400852174},
		{107.6217024175717, 77.2262614327518},
		{107.47749999999999, 77.1559292143521},
		{107.34448930337548, 77.06621236664773},
		{107.22525922961054, 76.95885712602784},
		{107.12213045646881, 76.83595304013635},
		{107.03711026821223, 76.69989229720377},
		{106.9718534860962, 76.55332316482452},
		{106.92763025915612, 76.39909844444043},
		{106.9053013422012, 76.24021994480574},
		{106.9053013422012, 76.07978005519425},
		{106.92763025915612, 75.92090155555957},
		{106.96823644259132, 75.77929096493835},
		{104.19818512966441, 75.77929096493835},
		{104.18761612886739, 75.79511612886739},
		{104.09114218444398, 75.85954725893812},
		{103.99211011316088, 75.88356320135385},
		{102.31288988683914, 75.88356320135385},
		{102.21385781555601, 75.85954725893811},
		{102.1173838711326, 75.79511612886738},
		{102.05295274106189, 75.698642184444},
		{102.02893679864614, 75.59961011316088},
	}...)
	pt = Point{102.02893679864614, 76.54038988683912}
	if pt.Inside(s.P[0]) {
		t.Errorf("point %v should not be inside shape", pt)
	}

	s = nil
	s = s.Builder([]Point{
		{92.1053013422012, 73.53978005519426},
		{92.12763025915612, 73.38090155555957},
		{92.1718534860962, 73.22667683517548},
		{92.23711026821223, 73.08010770279623},
		{92.32213045646881, 72.94404695986366},
		{92.42525922961055, 72.82114287397216},
		{92.54448930337549, 72.71378763335227},
		{92.6775, 72.6240707856479},
		{92.8217024175717, 72.5537385672482},
		{92.97428982006038, 72.5041599147826},
		{93.13229226724219, 72.47629982032649},
		{93.29263442120788, 72.47070054892805},
		{93.45219540431697, 72.48747108403596},
		{93.60786954353118, 72.52628500626058},
		{93.75662681880743, 72.58638684675596},
		{93.89557183899136, 72.6666067915617},
		{94.02200019731268, 72.765383450701},
		{94.13345110958682, 72.88079424886048},
		{94.2277553105799, 73.01059284613181},
		{94.30307727628899, 73.15225286046284},
		{94.35795095032907, 73.30301704081046},
		{94.39130827905281, 73.45995093389593},
		{94.4025, 73.62},
		{94.39130827905281, 73.78004906610408},
		{94.38266573585358, 73.82070903506167},
		{97.1568148703356, 73.82070903506167},
		{97.16738387113261, 73.80488387113262},
		{97.26385781555598, 73.7404527410619},
		{97.36288988683911, 73.71643679864614},
		{99.04211011316089, 73.71643679864614},
		{99.14114218444402, 73.7404527410619},
		{99.23761612886739, 73.80488387113262},
		{99.3020472589381, 73.90135781555601},
		{99.32606320135385, 74.00038988683914},
		{99.32606320135385, 74.32961011316085},
		{99.3020472589381, 74.42864218444399},
		{99.23761612886739, 74.52511612886738},
		{99.14114218444402, 74.5895472589381},
		{99.04211011316089, 74.61356320135386},
		{97.36288988683911, 74.61356320135386},
		{97.26385781555598, 74.5895472589381},
		{97.16738387113261, 74.52511612886738},
		{97.15681487033561, 74.50929096493836},
		{93.97761896916393, 74.50929096493836},
		{93.89557183899136, 74.5733932084383},
		{93.75662681880743, 74.65361315324405},
		{93.6078695435312, 74.71371499373943},
		{93.45219540431697, 74.75252891596405},
		{93.29263442120788, 74.76929945107196},
		{93.13229226724219, 74.76370017967352},
		{92.97428982006038, 74.7358400852174},
		{92.8217024175717, 74.6862614327518},
		{92.6775, 74.61592921435211},
		{92.54448930337549, 74.52621236664774},
		{92.42525922961055, 74.41885712602785},
		{92.32213045646881, 74.29595304013635},
		{92.23711026821223, 74.15989229720378},
		{92.1718534860962, 74.01332316482453},
		{92.12763025915612, 73.85909844444043},
		{92.1053013422012, 73.70021994480575},
	}...)
	pt = Point{92.60249999999999, 73.62}
	if !pt.Inside(s.P[0]) {
		t.Errorf("point %v should be inside shape", pt)
	}

	s = nil
	s = s.Builder([]Point{
		{92.1053013422012, 76.07978005519425},
		{92.12763025915612, 75.92090155555957},
		{92.1718534860962, 75.76667683517547},
		{92.23711026821223, 75.62010770279622},
		{92.32213045646881, 75.48404695986365},
		{92.42525922961055, 75.36114287397216},
		{92.54448930337549, 75.25378763335226},
		{92.6775, 75.1640707856479},
		{92.8217024175717, 75.0937385672482},
		{92.97428982006038, 75.0441599147826},
		{93.13229226724219, 75.01629982032648},
		{93.29263442120788, 75.01070054892804},
		{93.45219540431697, 75.02747108403595},
		{93.60786954353118, 75.06628500626057},
		{93.75662681880743, 75.12638684675595},
		{93.80494728004479, 75.1542846780587},
		{93.8543600286833, 75.13771381117687},
		{93.94879874257262, 75.09070903506165},
		{97.1568148703356, 75.09070903506165},
		{97.16738387113261, 75.07488387113261},
		{97.26385781555601, 75.0104527410619},
		{97.36288988683914, 74.98643679864615},
		{99.04211011316086, 74.98643679864615},
		{99.14114218444399, 75.0104527410619},
		{99.23761612886739, 75.07488387113261},
		{99.3020472589381, 75.17135781555601},
		{99.32606320135385, 75.27038988683914},
		{99.32606320135385, 75.59961011316085},
		{99.30204725893812, 75.69864218444397},
		{99.2376161288674, 75.79511612886738},
		{99.14114218444399, 75.85954725893811},
		{99.04211011316086, 75.88356320135385},
		{97.36288988683914, 75.88356320135385},
		{97.26385781555601, 75.85954725893811},
		{97.1673838711326, 75.79511612886738},
		{97.1568148703356, 75.77929096493835},
		{94.33475655556505, 75.77929096493835},
		{94.35795095032907, 75.84301704081045},
		{94.39130827905281, 75.99995093389592},
		{94.4025, 76.16},
		{94.39130827905281, 76.32004906610408},
		{94.35795095032907, 76.47698295918954},
		{94.30307727628899, 76.62774713953716},
		{94.2277553105799, 76.76940715386819},
		{94.13345110958683, 76.89920575113952},
		{94.02200019731268, 77.014616549299},
		{93.89557183899136, 77.1133932084383},
		{93.75662681880743, 77.19361315324404},
		{93.6078695435312, 77.25371499373942},
		{93.45219540431697, 77.29252891596404},
		{93.29263442120788, 77.30929945107195},
		{93.13229226724219, 77.30370017967351},
		{92.97428982006038, 77.2758400852174},
		{92.8217024175717, 77.2262614327518},
		{92.6775, 77.1559292143521},
		{92.54448930337549, 77.06621236664773},
		{92.42525922961055, 76.95885712602784},
		{92.32213045646881, 76.83595304013635},
		{92.23711026821223, 76.69989229720377},
		{92.1718534860962, 76.55332316482452},
		{92.12763025915612, 76.39909844444043},
		{92.1053013422012, 76.24021994480574},
	}...)
	pt = Point{92.60249999999999, 76.16}
	if !pt.Inside(s.P[0]) {
		t.Errorf("point %v should be inside shape", pt)
	}
}

func TestInsideThree(t *testing.T) {
	var s *Shapes
	s = s.Builder(
		/* poly0 ["1"] */ []Point{
			{-1.561404, 3.052632},
			{-1.245614, 3.052632},
			{-1.245614, 4.105263},
			{-1.561404, 4.105263},
		}...).Builder(
		/* poly1 ["26"] */ []Point{
			{-1.561403, 3.579113},
			{-1.561369, 3.575668},
			{-1.561260, 3.572225},
			{-1.561076, 3.568785},
			{-1.560817, 3.565350},
			{-1.560483, 3.561922},
			{-1.560074, 3.558502},
			{-1.559591, 3.555091},
			{-1.559033, 3.551692},
			{-1.558402, 3.548306},
			{-1.557696, 3.544934},
			{-1.556918, 3.541578},
			{-1.556066, 3.538241},
			{-1.555142, 3.534922},
			{-1.554145, 3.531625},
			{-1.553077, 3.528350},
			{-1.551938, 3.525099},
			{-1.550728, 3.521874},
			{-1.549448, 3.518676},
			{-1.548098, 3.515507},
			{-1.546680, 3.512368},
			{-1.545193, 3.509260},
			{-1.543639, 3.506186},
			{-1.542019, 3.503147},
			{-1.540332, 3.500143},
			{-1.538580, 3.497177},
			{-1.536765, 3.494250},
			{-1.534885, 3.491363},
			{-1.532943, 3.488518},
			{-1.530940, 3.485716},
			{-1.528876, 3.482958},
			{-1.526752, 3.480246},
			{-1.524569, 3.477581},
			{-1.522329, 3.474964},
			{-1.520033, 3.472397},
			{-1.517680, 3.469880},
			{-1.515274, 3.467416},
			{-1.512814, 3.465004},
			{-1.510303, 3.462647},
			{-1.507740, 3.460345},
			{-1.505128, 3.458099},
			{-1.502468, 3.455911},
			{-1.499760, 3.453782},
			{-1.497007, 3.451712},
			{-1.494209, 3.449702},
			{-1.491368, 3.447755},
			{-1.488485, 3.445869},
			{-1.485561, 3.444047},
			{-1.482599, 3.442289},
			{-1.479599, 3.440596},
			{-1.476563, 3.438969},
			{-1.473492, 3.437409},
			{-1.470388, 3.435916},
			{-1.467251, 3.434491},
			{-1.464085, 3.433135},
			{-1.460890, 3.431848},
			{-1.457667, 3.430631},
			{-1.454419, 3.429485},
			{-1.451146, 3.428410},
			{-1.447851, 3.427407},
			{-1.444534, 3.426476},
			{-1.441199, 3.425617},
			{-1.437845, 3.424831},
			{-1.434474, 3.424119},
			{-1.431090, 3.423480},
			{-1.427691, 3.422915},
			{-1.424282, 3.422425},
			{-1.420862, 3.422009},
			{-1.417435, 3.421668},
			{-1.414000, 3.421402},
			{-1.410561, 3.421210},
			{-1.407118, 3.421094},
			{-1.403674, 3.421053},
			{-1.400229, 3.421087},
			{-1.396787, 3.421196},
			{-1.393347, 3.421380},
			{-1.389912, 3.421639},
			{-1.386483, 3.421973},
			{-1.383063, 3.422382},
			{-1.379653, 3.422865},
			{-1.376253, 3.423423},
			{-1.372867, 3.424054},
			{-1.369495, 3.424760},
			{-1.366140, 3.425538},
			{-1.362802, 3.426390},
			{-1.359484, 3.427314},
			{-1.356186, 3.428311},
			{-1.352912, 3.429379},
			{-1.349661, 3.430518},
			{-1.346436, 3.431728},
			{-1.343238, 3.433009},
			{-1.340068, 3.434358},
			{-1.336929, 3.435776},
			{-1.333822, 3.437263},
			{-1.330748, 3.438817},
			{-1.327708, 3.440437},
			{-1.324704, 3.442124},
			{-1.321738, 3.443876},
			{-1.318811, 3.445692},
			{-1.315925, 3.447571},
			{-1.313079, 3.449513},
			{-1.310277, 3.451516},
			{-1.307520, 3.453581},
			{-1.304808, 3.455704},
			{-1.302143, 3.457887},
			{-1.299526, 3.460127},
			{-1.296958, 3.462424},
			{-1.294442, 3.464776},
			{-1.291977, 3.467182},
			{-1.289566, 3.469642},
			{-1.287208, 3.472154},
			{-1.284906, 3.474716},
			{-1.282661, 3.477328},
			{-1.280473, 3.479989},
			{-1.278343, 3.482696},
			{-1.276273, 3.485450},
			{-1.274264, 3.488247},
			{-1.272316, 3.491088},
			{-1.270431, 3.493971},
			{-1.268608, 3.496895},
			{-1.266851, 3.499857},
			{-1.265158, 3.502857},
			{-1.263531, 3.505893},
			{-1.261970, 3.508964},
			{-1.260477, 3.512069},
			{-1.259053, 3.515205},
			{-1.257696, 3.518371},
			{-1.256410, 3.521566},
			{-1.255193, 3.524789},
			{-1.254047, 3.528037},
			{-1.252972, 3.531310},
			{-1.251968, 3.534605},
			{-1.251037, 3.537922},
			{-1.250178, 3.541258},
			{-1.249393, 3.544611},
			{-1.248680, 3.547982},
			{-1.248042, 3.551367},
			{-1.247477, 3.554765},
			{-1.246986, 3.558174},
			{-1.246571, 3.561594},
			{-1.246229, 3.565021},
			{-1.245963, 3.568456},
			{-1.245772, 3.571895},
			{-1.245655, 3.575338},
			{-1.245614, 3.578782},
			{-1.245648, 3.582227},
			{-1.245757, 3.585670},
			{-1.245941, 3.589109},
			{-1.246201, 3.592544},
			{-1.246535, 3.595973},
			{-1.246943, 3.599393},
			{-1.247427, 3.602804},
			{-1.247984, 3.606203},
			{-1.248616, 3.609589},
			{-1.249321, 3.612961},
			{-1.250100, 3.616316},
			{-1.250952, 3.619654},
			{-1.251876, 3.622972},
			{-1.252872, 3.626270},
			{-1.253940, 3.629545},
			{-1.255080, 3.632795},
			{-1.256290, 3.636020},
			{-1.257570, 3.639218},
			{-1.258919, 3.642388},
			{-1.260338, 3.645527},
			{-1.261824, 3.648634},
			{-1.263378, 3.651709},
			{-1.264999, 3.654748},
			{-1.266685, 3.657752},
			{-1.268437, 3.660718},
			{-1.270253, 3.663645},
			{-1.272132, 3.666532},
			{-1.274074, 3.669377},
			{-1.276078, 3.672179},
			{-1.278142, 3.674937},
			{-1.280266, 3.677649},
			{-1.282448, 3.680314},
			{-1.284688, 3.682930},
			{-1.286985, 3.685498},
			{-1.289337, 3.688014},
			{-1.291744, 3.690479},
			{-1.294203, 3.692891},
			{-1.296715, 3.695248},
			{-1.299277, 3.697550},
			{-1.301890, 3.699796},
			{-1.304550, 3.701984},
			{-1.307258, 3.704113},
			{-1.310011, 3.706183},
			{-1.312809, 3.708192},
			{-1.315650, 3.710140},
			{-1.318533, 3.712026},
			{-1.321456, 3.713848},
			{-1.324418, 3.715606},
			{-1.327418, 3.717298},
			{-1.330455, 3.718925},
			{-1.333526, 3.720486},
			{-1.336630, 3.721979},
			{-1.339766, 3.723404},
			{-1.342933, 3.724760},
			{-1.346128, 3.726047},
			{-1.349350, 3.727263},
			{-1.352599, 3.728409},
			{-1.355871, 3.729485},
			{-1.359167, 3.730488},
			{-1.362483, 3.731419},
			{-1.365819, 3.732278},
			{-1.369173, 3.733064},
			{-1.372543, 3.733776},
			{-1.375928, 3.734415},
			{-1.379326, 3.734979},
			{-1.382736, 3.735470},
			{-1.386155, 3.735886},
			{-1.389583, 3.736227},
			{-1.393017, 3.736493},
			{-1.396457, 3.736685},
			{-1.399899, 3.736801},
			{-1.403344, 3.736842},
			{-1.406788, 3.736808},
			{-1.410231, 3.736699},
			{-1.413671, 3.736515},
			{-1.417106, 3.736256},
			{-1.420534, 3.735922},
			{-1.423954, 3.735513},
			{-1.427365, 3.735029},
			{-1.430764, 3.734472},
			{-1.434151, 3.733840},
			{-1.437522, 3.733135},
			{-1.440878, 3.732356},
			{-1.444215, 3.731505},
			{-1.447534, 3.730580},
			{-1.450831, 3.729584},
			{-1.454106, 3.728516},
			{-1.457357, 3.727376},
			{-1.460582, 3.726166},
			{-1.463780, 3.724886},
			{-1.466949, 3.723537},
			{-1.470088, 3.722118},
			{-1.473196, 3.720632},
			{-1.476270, 3.719078},
			{-1.479310, 3.717457},
			{-1.482313, 3.715771},
			{-1.485279, 3.714019},
			{-1.488206, 3.712203},
			{-1.491093, 3.710324},
			{-1.493938, 3.708382},
			{-1.496740, 3.706378},
			{-1.499498, 3.704314},
			{-1.502210, 3.702190},
			{-1.504875, 3.700008},
			{-1.507492, 3.697768},
			{-1.510059, 3.695471},
			{-1.512576, 3.693119},
			{-1.515040, 3.690713},
			{-1.517452, 3.688253},
			{-1.519809, 3.685741},
			{-1.522111, 3.683179},
			{-1.524357, 3.680567},
			{-1.526545, 3.677906},
			{-1.528674, 3.675199},
			{-1.530744, 3.672445},
			{-1.532754, 3.669647},
			{-1.534702, 3.666806},
			{-1.536587, 3.663923},
			{-1.538409, 3.661000},
			{-1.540167, 3.658038},
			{-1.541860, 3.655038},
			{-1.543487, 3.652002},
			{-1.545047, 3.648931},
			{-1.546540, 3.645826},
			{-1.547965, 3.642690},
			{-1.549321, 3.639524},
			{-1.550608, 3.636328},
			{-1.551825, 3.633106},
			{-1.552971, 3.629857},
			{-1.554046, 3.626585},
			{-1.555049, 3.623289},
			{-1.555981, 3.619973},
			{-1.556839, 3.616637},
			{-1.557625, 3.613283},
			{-1.558337, 3.609913},
			{-1.558976, 3.606528},
			{-1.559541, 3.603130},
			{-1.560031, 3.599721},
			{-1.560447, 3.596301},
			{-1.560788, 3.592873},
			{-1.561055, 3.589439},
			{-1.561246, 3.586000},
			{-1.561362, 3.582557},
		}...)
	hits, p1, p2 := crossings(s.P[0], s.P[1])
	if len(hits) != 1 {
		t.Errorf("found unexpected hits %v", hits)
	}
	// This zeroth point of p2 should be inside p1.
	if !p2.PS[0].Inside(p1) {
		t.Fatalf("target point %v not in p1=%v", p2.PS[0], p1)
	}
	// The hits are all added to p1.
	if len(p1.PS) != len(s.P[0].PS)+len(hits) {
		t.Errorf("p1 is unexpected size: is=%d was=%d", len(p1.PS), len(s.P[0].PS))
	}
	if len(p2.PS) != len(s.P[1].PS) {
		t.Errorf("p2 is unexpected size: is=%d was=%d", len(p2.PS), len(s.P[1].PS))
	}
	// Validate that a non-default point comparison indicates being inside
	if !p2.PS[3].Inside(p1) {
		t.Fatalf("target point %v not in s.P[0]", p2.PS[3])
	}
	aInB, bInA := insider(hits, p1, p2)
	if aInB || !bInA {
		t.Fatalf("%v %v %v", hits, aInB, bInA)
	}
}

func TestInsideTwo(t *testing.T) {
	var s *Shapes
	s = s.Builder(
		/* poly0 ["53^47.0^46.0^54.0^23.0^49.0^45.0^44.0^22.0^21.0^43.0^42.0^41.0^40.0^38.0^36.0^34.0^32.0^4.0^3.0^25.0^0.0^1.0^2.0^26.0^27.0^28.0^29.0^30.0^5.0^6.0"] */ []Point{
			{-1.385965, 0.421053},
			{-1.385954, 0.420037},
			{-1.385952, 0.419021},
			{-1.385935, 0.418315},
			{-1.385927, 0.417608},
			{-1.385894, 0.416593},
			{-1.385870, 0.415577},
			{-1.385838, 0.414872},
			{-1.385815, 0.414165},
			{-1.385759, 0.413151},
			{-1.385713, 0.412136},
			{-1.385665, 0.411431},
			{-1.385627, 0.410726},
			{-1.385549, 0.409713},
			{-1.385481, 0.408699},
			{-1.385418, 0.407996},
			{-1.385364, 0.407291},
			{-1.385265, 0.406280},
			{-1.385174, 0.405269},
			{-1.385096, 0.404566},
			{-1.385026, 0.403863},
			{-1.384905, 0.402855},
			{-1.384792, 0.401845},
			{-1.384699, 0.401145},
			{-1.384614, 0.400443},
			{-1.384471, 0.399438},
			{-1.384336, 0.398431},
			{-1.384227, 0.397733},
			{-1.384127, 0.397033},
			{-1.383962, 0.396031},
			{-1.383805, 0.395027},
			{-1.383681, 0.394332},
			{-1.383566, 0.393634},
			{-1.383379, 0.392636},
			{-1.383200, 0.391636},
			{-1.383061, 0.390943},
			{-1.382931, 0.390249},
			{-1.382722, 0.389255},
			{-1.382522, 0.388259},
			{-1.382368, 0.387569},
			{-1.382222, 0.386878},
			{-1.381992, 0.385889},
			{-1.381770, 0.384897},
			{-1.381600, 0.384211},
			{-1.381440, 0.383523},
			{-1.381188, 0.382539},
			{-1.380944, 0.381553},
			{-1.380760, 0.380871},
			{-1.380585, 0.380186},
			{-1.380311, 0.379208},
			{-1.380046, 0.378228},
			{-1.379847, 0.377550},
			{-1.379657, 0.376869},
			{-1.379362, 0.375897},
			{-1.379076, 0.374922},
			{-1.378862, 0.374249},
			{-1.378657, 0.373573},
			{-1.378341, 0.372607},
			{-1.378034, 0.371639},
			{-1.377805, 0.370971},
			{-1.377585, 0.370299},
			{-1.377248, 0.369341},
			{-1.376920, 0.368380},
			{-1.376677, 0.367716},
			{-1.376443, 0.367049},
			{-1.376085, 0.366099},
			{-1.375736, 0.365145},
			{-1.375478, 0.364487},
			{-1.375229, 0.363826},
			{-1.374851, 0.362883},
			{-1.374481, 0.361937},
			{-1.374209, 0.361285},
			{-1.373946, 0.360629},
			{-1.373547, 0.359695},
			{-1.373156, 0.358757},
			{-1.372871, 0.358111},
			{-1.372593, 0.357461},
			{-1.372174, 0.356536},
			{-1.371763, 0.355607},
			{-1.371463, 0.354967},
			{-1.371171, 0.354323},
			{-1.370732, 0.353408},
			{-1.370301, 0.352488},
			{-1.369987, 0.351855},
			{-1.369682, 0.351218},
			{-1.369222, 0.350311},
			{-1.368771, 0.349401},
			{-1.368444, 0.348775},
			{-1.368125, 0.348145},
			{-1.367646, 0.347249},
			{-1.367175, 0.346349},
			{-1.366834, 0.345730},
			{-1.366501, 0.345107},
			{-1.366002, 0.344222},
			{-1.365512, 0.343332},
			{-1.365158, 0.342721},
			{-1.364811, 0.342105},
			{-1.364294, 0.341231},
			{-1.363784, 0.340352},
			{-1.363416, 0.339749},
			{-1.363056, 0.339141},
			{-1.362520, 0.338278},
			{-1.361991, 0.337411},
			{-1.361610, 0.336816},
			{-1.361237, 0.336216},
			{-1.360682, 0.335365},
			{-1.360135, 0.334509},
			{-1.359741, 0.333923},
			{-1.359355, 0.333331},
			{-1.358781, 0.332493},
			{-1.358215, 0.331649},
			{-1.357809, 0.331071},
			{-1.357410, 0.330488},
			{-1.356818, 0.329662},
			{-1.356234, 0.328831},
			{-1.355815, 0.328262},
			{-1.355404, 0.327688},
			{-1.354794, 0.326875},
			{-1.354192, 0.326057},
			{-1.353760, 0.325498},
			{-1.353336, 0.324932},
			{-1.352709, 0.324133},
			{-1.352089, 0.323329},
			{-1.351646, 0.322778},
			{-1.351210, 0.322223},
			{-1.350565, 0.321437},
			{-1.349928, 0.320646},
			{-1.349473, 0.320106},
			{-1.349025, 0.319560},
			{-1.348363, 0.318789},
			{-1.347709, 0.318012},
			{-1.347242, 0.317482},
			{-1.346782, 0.316945},
			{-1.346104, 0.316189},
			{-1.345432, 0.315427},
			{-1.344954, 0.314907},
			{-1.344482, 0.314380},
			{-1.343788, 0.313639},
			{-1.343100, 0.312892},
			{-1.342611, 0.312382},
			{-1.342128, 0.311866},
			{-1.341417, 0.311140},
			{-1.340713, 0.310408},
			{-1.340213, 0.309909},
			{-1.339719, 0.309404},
			{-1.338993, 0.308694},
			{-1.338273, 0.307977},
			{-1.337761, 0.307489},
			{-1.337256, 0.306995},
			{-1.336515, 0.306301},
			{-1.335780, 0.305600},
			{-1.335258, 0.305123},
			{-1.334742, 0.304640},
			{-1.333986, 0.303962},
			{-1.333236, 0.303278},
			{-1.332704, 0.302813},
			{-1.332177, 0.302341},
			{-1.331406, 0.301680},
			{-1.330641, 0.301011},
			{-1.330099, 0.300558},
			{-1.329563, 0.300098},
			{-1.328778, 0.299454},
			{-1.327998, 0.298802},
			{-1.327446, 0.298361},
			{-1.326900, 0.297913},
			{-1.326101, 0.297286},
			{-1.325308, 0.296652},
			{-1.324746, 0.296223},
			{-1.324190, 0.295786},
			{-1.323378, 0.295177},
			{-1.322571, 0.294560},
			{-1.322000, 0.294143},
			{-1.321435, 0.293719},
			{-1.320609, 0.293128},
			{-1.319789, 0.292529},
			{-1.319209, 0.292124},
			{-1.318635, 0.291713},
			{-1.317796, 0.291139},
			{-1.316963, 0.290558},
			{-1.316375, 0.290167},
			{-1.315792, 0.289768},
			{-1.314941, 0.289213},
			{-1.314095, 0.288650},
			{-1.313499, 0.288272},
			{-1.312907, 0.287886},
			{-1.312044, 0.287349},
			{-1.311187, 0.286805},
			{-1.310582, 0.286440},
			{-1.309982, 0.286067},
			{-1.309108, 0.285549},
			{-1.308238, 0.285024},
			{-1.307626, 0.284672},
			{-1.307018, 0.284312},
			{-1.306132, 0.283814},
			{-1.305252, 0.283307},
			{-1.304632, 0.282969},
			{-1.304016, 0.282622},
			{-1.303120, 0.282143},
			{-1.302228, 0.281656},
			{-1.301601, 0.281331},
			{-1.300978, 0.280998},
			{-1.300072, 0.280539},
			{-1.299170, 0.280072},
			{-1.298535, 0.279761},
			{-1.297905, 0.279441},
			{-1.296989, 0.279002},
			{-1.296077, 0.278554},
			{-1.295436, 0.278257},
			{-1.294799, 0.277951},
			{-1.293874, 0.277532},
			{-1.292953, 0.277105},
			{-1.292305, 0.276821},
			{-1.291662, 0.276530},
			{-1.290728, 0.276131},
			{-1.289797, 0.275724},
			{-1.289144, 0.275454},
			{-1.288494, 0.275177},
			{-1.287551, 0.274798},
			{-1.286612, 0.274412},
			{-1.285953, 0.274157},
			{-1.285297, 0.273893},
			{-1.284347, 0.273536},
			{-1.283399, 0.273169},
			{-1.282735, 0.272929},
			{-1.282073, 0.272680},
			{-1.281115, 0.272343},
			{-1.280160, 0.271998},
			{-1.279490, 0.271772},
			{-1.278824, 0.271537},
			{-1.277858, 0.271221},
			{-1.276896, 0.270897},
			{-1.276222, 0.270686},
			{-1.275550, 0.270466},
			{-1.274578, 0.270171},
			{-1.273609, 0.269867},
			{-1.272930, 0.269671},
			{-1.272254, 0.269466},
			{-1.271275, 0.269192},
			{-1.270300, 0.268910},
			{-1.269617, 0.268728},
			{-1.268936, 0.268538},
			{-1.267952, 0.268286},
			{-1.266971, 0.268025},
			{-1.266284, 0.267858},
			{-1.265600, 0.267683},
			{-1.264610, 0.267452},
			{-1.263623, 0.267213},
			{-1.262933, 0.267061},
			{-1.262245, 0.266901},
			{-1.261251, 0.266692},
			{-1.260259, 0.266474},
			{-1.259565, 0.266337},
			{-1.258874, 0.266192},
			{-1.257876, 0.266005},
			{-1.256879, 0.265808},
			{-1.256183, 0.265687},
			{-1.255488, 0.265557},
			{-1.254486, 0.265391},
			{-1.253485, 0.265217},
			{-1.252787, 0.265111},
			{-1.252090, 0.264996},
			{-1.251084, 0.264852},
			{-1.250080, 0.264699},
			{-1.249379, 0.264609},
			{-1.248680, 0.264509},
			{-1.247671, 0.264387},
			{-1.246664, 0.264256},
			{-1.245961, 0.264181},
			{-1.245260, 0.264096},
			{-1.244249, 0.263997},
			{-1.243239, 0.263888},
			{-1.242535, 0.263828},
			{-1.241832, 0.263759},
			{-1.240819, 0.263681},
			{-1.239807, 0.263595},
			{-1.239102, 0.263550},
			{-1.238397, 0.263496},
			{-1.237383, 0.263441},
			{-1.236369, 0.263376},
			{-1.235663, 0.263347},
			{-1.234957, 0.263308},
			{-1.233942, 0.263275},
			{-1.232927, 0.263233},
			{-1.232221, 0.263219},
			{-1.231515, 0.263195},
			{-1.230499, 0.263184},
			{-1.229483, 0.263164},
			{-1.228777, 0.263166},
			{-1.228070, 0.263158},
			{1.228070, 0.263158},
			{1.228070, 0.754386},
			{-0.540206, 0.754386},
			{0.643678, 2.069813},
			{0.643671, 2.069819},
			{0.644918, 2.071207},
			{0.647164, 2.073819},
			{0.649352, 2.076480},
			{0.651481, 2.079187},
			{0.653551, 2.081941},
			{0.655561, 2.084739},
			{0.657509, 2.087580},
			{0.657689, 2.087856},
			{0.657692, 2.087854},
			{1.008569, 2.614170},
			{0.878013, 2.701208},
			{1.018418, 2.982019},
			{1.018412, 2.982022},
			{1.018804, 2.982797},
			{1.020294, 2.985902},
			{1.021716, 2.989040},
			{1.023069, 2.992208},
			{1.024352, 2.995405},
			{1.025566, 2.998628},
			{1.026708, 3.001878},
			{1.027780, 3.005152},
			{1.028780, 3.008448},
			{1.029708, 3.011765},
			{1.030563, 3.015102},
			{1.031345, 3.018457},
			{1.032054, 3.021828},
			{1.032689, 3.025213},
			{1.033250, 3.028612},
			{1.033737, 3.032022},
			{1.034149, 3.035442},
			{1.034487, 3.038870},
			{1.034750, 3.042305},
			{1.034937, 3.045744},
			{1.035050, 3.049187},
			{1.035088, 3.052632},
			{1.035088, 3.403509},
			{0.877193, 3.403509},
			{1.018418, 3.474121},
			{0.842980, 3.824999},
			{0.701754, 3.754386},
			{0.772367, 3.895611},
			{0.421490, 4.071050},
			{0.350877, 3.929825},
			{0.350877, 4.087719},
			{-0.350877, 4.087719},
			{-0.350877, 3.929825},
			{-0.421490, 4.071050},
			{-0.560977, 4.001306},
			{-0.561700, 4.002732},
			{-0.563324, 4.005770},
			{-0.565014, 4.008772},
			{-0.566768, 4.011736},
			{-0.568587, 4.014661},
			{-0.570470, 4.017546},
			{-0.572415, 4.020389},
			{-0.574421, 4.023189},
			{-0.576488, 4.025945},
			{-0.578615, 4.028655},
			{-0.580800, 4.031317},
			{-0.583043, 4.033932},
			{-0.585342, 4.036497},
			{-0.587697, 4.039011},
			{-0.590106, 4.041473},
			{-0.592568, 4.043882},
			{-0.595082, 4.046237},
			{-0.597647, 4.048536},
			{-0.600262, 4.050779},
			{-0.602924, 4.052964},
			{-0.605634, 4.055091},
			{-0.608390, 4.057158},
			{-0.611190, 4.059164},
			{-0.614033, 4.061109},
			{-0.616918, 4.062992},
			{-0.619843, 4.064811},
			{-0.622807, 4.066565},
			{-0.625809, 4.068255},
			{-0.628847, 4.069879},
			{-0.631919, 4.071436},
			{-0.635025, 4.072926},
			{-0.638163, 4.074347},
			{-0.641331, 4.075700},
			{-0.644527, 4.076984},
			{-0.647751, 4.078197},
			{-0.651001, 4.079340},
			{-0.654275, 4.080411},
			{-0.657571, 4.081411},
			{-0.660888, 4.082339},
			{-0.664225, 4.083194},
			{-0.667580, 4.083977},
			{-0.670951, 4.084685},
			{-0.674336, 4.085321},
			{-0.677735, 4.085882},
			{-0.681145, 4.086368},
			{-0.684565, 4.086781},
			{-0.687993, 4.087118},
			{-0.691428, 4.087381},
			{-0.694867, 4.087569},
			{-0.698310, 4.087682},
			{-0.701754, 4.087719},
			{-0.705199, 4.087682},
			{-0.708642, 4.087569},
			{-0.712081, 4.087381},
			{-0.715516, 4.087118},
			{-0.718944, 4.086781},
			{-0.722364, 4.086368},
			{-0.725774, 4.085882},
			{-0.729173, 4.085321},
			{-0.732558, 4.084685},
			{-0.735929, 4.083977},
			{-0.739284, 4.083194},
			{-0.742621, 4.082339},
			{-0.745938, 4.081411},
			{-0.749234, 4.080411},
			{-0.752508, 4.079340},
			{-0.755758, 4.078197},
			{-0.758981, 4.076984},
			{-0.762178, 4.075700},
			{-0.765346, 4.074347},
			{-0.768484, 4.072926},
			{-0.771589, 4.071436},
			{-0.774662, 4.069879},
			{-0.777700, 4.068255},
			{-0.780702, 4.066565},
			{-0.783666, 4.064811},
			{-0.786591, 4.062992},
			{-0.789476, 4.061109},
			{-0.792319, 4.059164},
			{-0.795119, 4.057158},
			{-0.797875, 4.055091},
			{-0.800584, 4.052964},
			{-0.803247, 4.050779},
			{-0.805862, 4.048536},
			{-0.808427, 4.046237},
			{-0.810941, 4.043882},
			{-0.813403, 4.041473},
			{-0.988841, 3.866034},
			{-0.988836, 3.866029},
			{-0.989454, 3.865419},
			{-0.991849, 3.862943},
			{-0.994190, 3.860416},
			{-0.996475, 3.857839},
			{-0.998704, 3.855212},
			{-1.000874, 3.852537},
			{-1.002986, 3.849816},
			{-1.005038, 3.847049},
			{-1.007029, 3.844238},
			{-1.008958, 3.841384},
			{-1.010825, 3.838489},
			{-1.012627, 3.835554},
			{-1.014366, 3.832580},
			{-1.016039, 3.829569},
			{-1.017646, 3.826522},
			{-1.018410, 3.824994},
			{-1.018418, 3.824999},
			{-1.193857, 3.474121},
			{-1.193851, 3.474118},
			{-1.194243, 3.473344},
			{-1.195733, 3.470238},
			{-1.197154, 3.467100},
			{-1.198507, 3.463932},
			{-1.199791, 3.460736},
			{-1.201004, 3.457512},
			{-1.202147, 3.454262},
			{-1.203218, 3.450989},
			{-1.204218, 3.447692},
			{-1.205146, 3.444375},
			{-1.206001, 3.441038},
			{-1.206784, 3.437683},
			{-1.207492, 3.434313},
			{-1.208128, 3.430927},
			{-1.208689, 3.427528},
			{-1.209176, 3.424118},
			{-1.209588, 3.420698},
			{-1.209925, 3.417270},
			{-1.210188, 3.413836},
			{-1.210376, 3.410396},
			{-1.210489, 3.406953},
			{-1.210526, 3.403509},
			{-1.210526, 3.228070},
			{-1.210489, 3.224626},
			{-1.210376, 3.221183},
			{-1.210188, 3.217743},
			{-1.209925, 3.214309},
			{-1.209588, 3.210881},
			{-1.209176, 3.207461},
			{-1.208689, 3.204051},
			{-1.208128, 3.200652},
			{-1.207492, 3.197266},
			{-1.206784, 3.193895},
			{-1.206001, 3.190541},
			{-1.205146, 3.187204},
			{-1.204218, 3.183887},
			{-1.203218, 3.180590},
			{-1.202147, 3.177317},
			{-1.201004, 3.174067},
			{-1.199791, 3.170843},
			{-1.198507, 3.167646},
			{-1.197154, 3.164479},
			{-1.195733, 3.161341},
			{-1.194243, 3.158235},
			{-1.192686, 3.155162},
			{-1.191062, 3.152125},
			{-1.189372, 3.149123},
			{-1.187618, 3.146159},
			{-1.185799, 3.143233},
			{-1.183916, 3.140349},
			{-1.181971, 3.137505},
			{-1.179965, 3.134705},
			{-1.177898, 3.131950},
			{-1.175771, 3.129240},
			{-1.173586, 3.126577},
			{-1.171343, 3.123963},
			{-1.169044, 3.121398},
			{-1.166689, 3.118884},
			{-1.164280, 3.116422},
			{-1.161818, 3.114013},
			{-1.159304, 3.111658},
			{-1.156739, 3.109359},
			{-1.154124, 3.107116},
			{-1.151462, 3.104931},
			{-1.148752, 3.102804},
			{-1.145996, 3.100737},
			{-1.143196, 3.098730},
			{-1.140353, 3.096785},
			{-1.137468, 3.094903},
			{-1.134543, 3.093084},
			{-1.131579, 3.091329},
			{-1.128577, 3.089640},
			{-1.125539, 3.088016},
			{-1.122467, 3.086459},
			{-1.119361, 3.084969},
			{-1.116223, 3.083547},
			{-1.113055, 3.082194},
			{-1.109859, 3.080911},
			{-1.106635, 3.079698},
			{-1.103385, 3.078555},
			{-1.100111, 3.077483},
			{-1.096815, 3.076483},
			{-1.093498, 3.075556},
			{-1.090161, 3.074700},
			{-1.086806, 3.073918},
			{-1.083435, 3.073209},
			{-1.080050, 3.072574},
			{-1.076651, 3.072013},
			{-1.073241, 3.071526},
			{-1.069821, 3.071114},
			{-1.066393, 3.070776},
			{-1.062958, 3.070514},
			{-1.059519, 3.070326},
			{-1.056076, 3.070213},
			{-1.052632, 3.070175},
			{-0.877193, 3.070175},
			{-0.873749, 3.070213},
			{-0.870306, 3.070326},
			{-0.866866, 3.070514},
			{-0.863432, 3.070776},
			{-0.860003, 3.071114},
			{-0.856584, 3.071526},
			{-0.853174, 3.072013},
			{-0.849775, 3.072574},
			{-0.846389, 3.073209},
			{-0.843018, 3.073918},
			{-0.839664, 3.074700},
			{-0.836327, 3.075556},
			{-0.833009, 3.076483},
			{-0.829713, 3.077483},
			{-0.826439, 3.078555},
			{-0.823190, 3.079698},
			{-0.819966, 3.080911},
			{-0.816769, 3.082194},
			{-0.813601, 3.083547},
			{-0.810464, 3.084969},
			{-0.807358, 3.086459},
			{-0.804285, 3.088016},
			{-0.801247, 3.089640},
			{-0.798246, 3.091329},
			{-0.795281, 3.093084},
			{-0.792356, 3.094903},
			{-0.789471, 3.096785},
			{-0.786628, 3.098730},
			{-0.783828, 3.100737},
			{-0.781073, 3.102804},
			{-0.778363, 3.104931},
			{-0.775700, 3.107116},
			{-0.773086, 3.109359},
			{-0.770521, 3.111658},
			{-0.768007, 3.114013},
			{-0.765545, 3.116422},
			{-0.763136, 3.118884},
			{-0.760781, 3.121398},
			{-0.758481, 3.123963},
			{-0.756239, 3.126577},
			{-0.754053, 3.129240},
			{-0.751927, 3.131950},
			{-0.749860, 3.134705},
			{-0.747853, 3.137505},
			{-0.745908, 3.140349},
			{-0.744026, 3.143233},
			{-0.742207, 3.146159},
			{-0.740452, 3.149123},
			{-0.738762, 3.152125},
			{-0.737139, 3.155162},
			{-0.735581, 3.158235},
			{-0.734092, 3.161341},
			{-0.732670, 3.164479},
			{-0.731317, 3.167646},
			{-0.730034, 3.170843},
			{-0.728820, 3.174067},
			{-0.727678, 3.177317},
			{-0.726606, 3.180590},
			{-0.725606, 3.183887},
			{-0.724678, 3.187204},
			{-0.723823, 3.190541},
			{-0.723041, 3.193895},
			{-0.722332, 3.197266},
			{-0.721697, 3.200652},
			{-0.721136, 3.204051},
			{-0.720649, 3.207461},
			{-0.720237, 3.210881},
			{-0.719899, 3.214309},
			{-0.719636, 3.217743},
			{-0.719449, 3.221183},
			{-0.719336, 3.224626},
			{-0.719298, 3.228070},
			{-0.719298, 3.366235},
			{-0.584067, 3.636698},
			{-0.313603, 3.771930},
			{0.313603, 3.771930},
			{0.584067, 3.636698},
			{0.719298, 3.366235},
			{0.719298, 3.089905},
			{0.564925, 2.781159},
			{0.225854, 2.272552},
			{-1.345432, 0.526679},
			{-1.345428, 0.526675},
			{-1.345845, 0.526218},
			{-1.346310, 0.525686},
			{-1.346782, 0.525160},
			{-1.347443, 0.524389},
			{-1.348111, 0.523624},
			{-1.348565, 0.523082},
			{-1.349025, 0.522545},
			{-1.349669, 0.521760},
			{-1.350320, 0.520981},
			{-1.350762, 0.520429},
			{-1.351210, 0.519883},
			{-1.351837, 0.519084},
			{-1.352471, 0.518290},
			{-1.352900, 0.517729},
			{-1.353336, 0.517173},
			{-1.353946, 0.516360},
			{-1.354563, 0.515553},
			{-1.354980, 0.514983},
			{-1.355404, 0.514417},
			{-1.355995, 0.513592},
			{-1.356594, 0.512771},
			{-1.356998, 0.512192},
			{-1.357410, 0.511617},
			{-1.357984, 0.510779},
			{-1.358565, 0.509946},
			{-1.358956, 0.509357},
			{-1.359355, 0.508774},
			{-1.359910, 0.507924},
			{-1.360473, 0.507078},
			{-1.360851, 0.506481},
			{-1.361237, 0.505889},
			{-1.361774, 0.505027},
			{-1.362318, 0.504169},
			{-1.362683, 0.503564},
			{-1.363056, 0.502964},
			{-1.363574, 0.502090},
			{-1.364099, 0.501221},
			{-1.364451, 0.500608},
			{-1.364811, 0.500000},
			{-1.365309, 0.499115},
			{-1.365815, 0.498234},
			{-1.366154, 0.497614},
			{-1.366501, 0.496998},
			{-1.366980, 0.496102},
			{-1.367466, 0.495211},
			{-1.367791, 0.494583},
			{-1.368125, 0.493960},
			{-1.368584, 0.493054},
			{-1.369051, 0.492152},
			{-1.369362, 0.491518},
			{-1.369682, 0.490888},
			{-1.370121, 0.489972},
			{-1.370568, 0.489060},
			{-1.370866, 0.488419},
			{-1.371171, 0.487782},
			{-1.371591, 0.486857},
			{-1.372018, 0.485935},
			{-1.372301, 0.485288},
			{-1.372593, 0.484644},
			{-1.372992, 0.483710},
			{-1.373399, 0.482779},
			{-1.373668, 0.482126},
			{-1.373946, 0.481476},
			{-1.374324, 0.480534},
			{-1.374711, 0.479594},
			{-1.374966, 0.478935},
			{-1.375229, 0.478280},
			{-1.375587, 0.477329},
			{-1.375953, 0.476382},
			{-1.376194, 0.475717},
			{-1.376443, 0.475056},
			{-1.376780, 0.474098},
			{-1.377125, 0.473142},
			{-1.377351, 0.472473},
			{-1.377585, 0.471806},
			{-1.377901, 0.470841},
			{-1.378226, 0.469878},
			{-1.378437, 0.469204},
			{-1.378657, 0.468532},
			{-1.378952, 0.467560},
			{-1.379255, 0.466591},
			{-1.379452, 0.465912},
			{-1.379657, 0.465236},
			{-1.379931, 0.464258},
			{-1.380213, 0.463282},
			{-1.380394, 0.462599},
			{-1.380585, 0.461919},
			{-1.380837, 0.460935},
			{-1.381098, 0.459953},
			{-1.381265, 0.459266},
			{-1.381440, 0.458582},
			{-1.381671, 0.457593},
			{-1.381910, 0.456606},
			{-1.382062, 0.455915},
			{-1.382222, 0.455227},
			{-1.382431, 0.454233},
			{-1.382649, 0.453241},
			{-1.382786, 0.452548},
			{-1.382931, 0.451856},
			{-1.383118, 0.450858},
			{-1.383315, 0.449861},
			{-1.383436, 0.449165},
			{-1.383566, 0.448471},
			{-1.383732, 0.447469},
			{-1.383906, 0.446468},
			{-1.384012, 0.445769},
			{-1.384127, 0.445072},
			{-1.384271, 0.444067},
			{-1.384423, 0.443062},
			{-1.384514, 0.442362},
			{-1.384614, 0.441662},
			{-1.384736, 0.440654},
			{-1.384866, 0.439646},
			{-1.384942, 0.438944},
			{-1.385026, 0.438242},
			{-1.385126, 0.437231},
			{-1.385235, 0.436221},
			{-1.385295, 0.435517},
			{-1.385364, 0.434814},
			{-1.385442, 0.433801},
			{-1.385528, 0.432789},
			{-1.385573, 0.432084},
			{-1.385627, 0.431379},
			{-1.385682, 0.430365},
			{-1.385747, 0.429351},
			{-1.385776, 0.428645},
			{-1.385815, 0.427940},
			{-1.385848, 0.426925},
			{-1.385890, 0.425910},
			{-1.385904, 0.425203},
			{-1.385927, 0.424497},
			{-1.385938, 0.423481},
			{-1.385959, 0.422466},
			{-1.385957, 0.421759},
		}...).Builder(
		/* poly1 ["31"] */ []Point{
			{-0.859647, 3.753518},
			{-0.859590, 3.750074},
			{-0.859459, 3.746631},
			{-0.859252, 3.743193},
			{-0.858970, 3.739760},
			{-0.858614, 3.736334},
			{-0.858183, 3.732916},
			{-0.857677, 3.729509},
			{-0.857097, 3.726113},
			{-0.856443, 3.722731},
			{-0.855716, 3.719364},
			{-0.854916, 3.716014},
			{-0.854042, 3.712682},
			{-0.853096, 3.709370},
			{-0.852078, 3.706079},
			{-0.850988, 3.702811},
			{-0.849828, 3.699568},
			{-0.848597, 3.696351},
			{-0.847296, 3.693161},
			{-0.845925, 3.690001},
			{-0.844487, 3.686871},
			{-0.842980, 3.683773},
			{-0.841406, 3.680709},
			{-0.839765, 3.677680},
			{-0.838059, 3.674688},
			{-0.836288, 3.671733},
			{-0.834453, 3.668818},
			{-0.832555, 3.665944},
			{-0.830594, 3.663111},
			{-0.828572, 3.660323},
			{-0.826490, 3.657578},
			{-0.824349, 3.654880},
			{-0.822149, 3.652230},
			{-0.819892, 3.649628},
			{-0.817578, 3.647075},
			{-0.815210, 3.644574},
			{-0.812787, 3.642125},
			{-0.810312, 3.639730},
			{-0.807785, 3.637389},
			{-0.805207, 3.635104},
			{-0.802581, 3.632875},
			{-0.799906, 3.630705},
			{-0.797184, 3.628593},
			{-0.794417, 3.626541},
			{-0.791607, 3.624550},
			{-0.788753, 3.622621},
			{-0.785858, 3.620754},
			{-0.782922, 3.618952},
			{-0.779949, 3.617213},
			{-0.776938, 3.615540},
			{-0.773891, 3.613933},
			{-0.770810, 3.612393},
			{-0.767696, 3.610920},
			{-0.764550, 3.609516},
			{-0.761375, 3.608180},
			{-0.758171, 3.606914},
			{-0.754941, 3.605719},
			{-0.751685, 3.604594},
			{-0.748406, 3.603540},
			{-0.745104, 3.602558},
			{-0.741781, 3.601649},
			{-0.738440, 3.600812},
			{-0.735081, 3.600048},
			{-0.731706, 3.599358},
			{-0.728317, 3.598742},
			{-0.724915, 3.598199},
			{-0.721503, 3.597731},
			{-0.718081, 3.597338},
			{-0.714651, 3.597019},
			{-0.711215, 3.596775},
			{-0.707774, 3.596606},
			{-0.704331, 3.596512},
			{-0.700886, 3.596494},
			{-0.697442, 3.596550},
			{-0.694000, 3.596682},
			{-0.690561, 3.596888},
			{-0.687128, 3.597170},
			{-0.683702, 3.597527},
			{-0.680285, 3.597958},
			{-0.676877, 3.598463},
			{-0.673482, 3.599043},
			{-0.670100, 3.599697},
			{-0.666733, 3.600424},
			{-0.663382, 3.601225},
			{-0.660050, 3.602098},
			{-0.656738, 3.603044},
			{-0.653447, 3.604062},
			{-0.650179, 3.605152},
			{-0.646936, 3.606313},
			{-0.643719, 3.607544},
			{-0.640529, 3.608845},
			{-0.637369, 3.610215},
			{-0.634239, 3.611654},
			{-0.631142, 3.613161},
			{-0.628078, 3.614735},
			{-0.625049, 3.616375},
			{-0.622056, 3.618081},
			{-0.619102, 3.619852},
			{-0.616187, 3.621687},
			{-0.613312, 3.623586},
			{-0.610480, 3.625546},
			{-0.607691, 3.627568},
			{-0.604947, 3.629650},
			{-0.602249, 3.631792},
			{-0.599598, 3.633991},
			{-0.596996, 3.636249},
			{-0.594444, 3.638562},
			{-0.591943, 3.640931},
			{-0.589494, 3.643353},
			{-0.587098, 3.645829},
			{-0.584757, 3.648356},
			{-0.582472, 3.650933},
			{-0.580244, 3.653560},
			{-0.578073, 3.656235},
			{-0.575961, 3.658956},
			{-0.573910, 3.661723},
			{-0.571919, 3.664534},
			{-0.569989, 3.667388},
			{-0.568123, 3.670283},
			{-0.566320, 3.673218},
			{-0.564581, 3.676192},
			{-0.562908, 3.679203},
			{-0.561301, 3.682250},
			{-0.559761, 3.685331},
			{-0.558288, 3.688445},
			{-0.556884, 3.691590},
			{-0.555549, 3.694765},
			{-0.554283, 3.697969},
			{-0.553087, 3.701199},
			{-0.551962, 3.704455},
			{-0.550909, 3.707735},
			{-0.549927, 3.711037},
			{-0.549017, 3.714359},
			{-0.548181, 3.717701},
			{-0.547417, 3.721059},
			{-0.546727, 3.724434},
			{-0.546110, 3.727823},
			{-0.545568, 3.731225},
			{-0.545100, 3.734638},
			{-0.544706, 3.738060},
			{-0.544387, 3.741490},
			{-0.544143, 3.744926},
			{-0.543974, 3.748366},
			{-0.543881, 3.751810},
			{-0.543862, 3.755254},
			{-0.543919, 3.758698},
			{-0.544050, 3.762141},
			{-0.544257, 3.765579},
			{-0.544539, 3.769012},
			{-0.544895, 3.772438},
			{-0.545326, 3.775856},
			{-0.545832, 3.779263},
			{-0.546412, 3.782659},
			{-0.547065, 3.786041},
			{-0.547793, 3.789408},
			{-0.548593, 3.792758},
			{-0.549467, 3.796090},
			{-0.550413, 3.799402},
			{-0.551431, 3.802693},
			{-0.552520, 3.805961},
			{-0.553681, 3.809204},
			{-0.554912, 3.812421},
			{-0.556213, 3.815611},
			{-0.557583, 3.818771},
			{-0.559022, 3.821901},
			{-0.560529, 3.824999},
			{-0.562103, 3.828063},
			{-0.563744, 3.831092},
			{-0.565450, 3.834084},
			{-0.567221, 3.837039},
			{-0.569056, 3.839954},
			{-0.570954, 3.842828},
			{-0.572915, 3.845660},
			{-0.574936, 3.848449},
			{-0.577018, 3.851194},
			{-0.579160, 3.853892},
			{-0.581360, 3.856542},
			{-0.583617, 3.859144},
			{-0.585930, 3.861697},
			{-0.588299, 3.864198},
			{-0.590722, 3.866647},
			{-0.593197, 3.869042},
			{-0.595724, 3.871383},
			{-0.598301, 3.873668},
			{-0.600928, 3.875897},
			{-0.603603, 3.878067},
			{-0.606324, 3.880179},
			{-0.609091, 3.882231},
			{-0.611902, 3.884222},
			{-0.614756, 3.886151},
			{-0.617651, 3.888018},
			{-0.620586, 3.889820},
			{-0.623560, 3.891559},
			{-0.626571, 3.893232},
			{-0.629618, 3.894839},
			{-0.632699, 3.896379},
			{-0.635813, 3.897852},
			{-0.638958, 3.899256},
			{-0.642134, 3.900592},
			{-0.645337, 3.901858},
			{-0.648568, 3.903053},
			{-0.651824, 3.904178},
			{-0.655103, 3.905232},
			{-0.658405, 3.906213},
			{-0.661727, 3.907123},
			{-0.665069, 3.907960},
			{-0.668428, 3.908724},
			{-0.671803, 3.909414},
			{-0.675192, 3.910030},
			{-0.678593, 3.910573},
			{-0.682006, 3.911041},
			{-0.685428, 3.911434},
			{-0.688858, 3.911753},
			{-0.692294, 3.911997},
			{-0.695735, 3.912166},
			{-0.699178, 3.912260},
			{-0.702623, 3.912278},
			{-0.706067, 3.912222},
			{-0.709509, 3.912090},
			{-0.712947, 3.911883},
			{-0.716381, 3.911602},
			{-0.719807, 3.911245},
			{-0.723224, 3.910814},
			{-0.726632, 3.910309},
			{-0.730027, 3.909729},
			{-0.733409, 3.909075},
			{-0.736776, 3.908348},
			{-0.740126, 3.907547},
			{-0.743459, 3.906674},
			{-0.746771, 3.905728},
			{-0.750062, 3.904710},
			{-0.753329, 3.903620},
			{-0.756573, 3.902459},
			{-0.759790, 3.901228},
			{-0.762979, 3.899927},
			{-0.766140, 3.898557},
			{-0.769269, 3.897118},
			{-0.772367, 3.895611},
			{-0.775431, 3.894037},
			{-0.778460, 3.892397},
			{-0.781452, 3.890691},
			{-0.784407, 3.888920},
			{-0.787322, 3.887085},
			{-0.790197, 3.885186},
			{-0.793029, 3.883226},
			{-0.795818, 3.881204},
			{-0.798562, 3.879122},
			{-0.801260, 3.876980},
			{-0.803911, 3.874780},
			{-0.806513, 3.872523},
			{-0.809065, 3.870210},
			{-0.811566, 3.867841},
			{-0.814015, 3.865419},
			{-0.816411, 3.862943},
			{-0.818751, 3.860416},
			{-0.821037, 3.857839},
			{-0.823265, 3.855212},
			{-0.825436, 3.852537},
			{-0.827547, 3.849816},
			{-0.829599, 3.847049},
			{-0.831590, 3.844238},
			{-0.833519, 3.841384},
			{-0.835386, 3.838489},
			{-0.837189, 3.835554},
			{-0.838927, 3.832580},
			{-0.840600, 3.829569},
			{-0.842208, 3.826522},
			{-0.843748, 3.823441},
			{-0.845220, 3.820327},
			{-0.846625, 3.817182},
			{-0.847960, 3.814007},
			{-0.849226, 3.810803},
			{-0.850422, 3.807572},
			{-0.851546, 3.804317},
			{-0.852600, 3.801037},
			{-0.853582, 3.797735},
			{-0.854491, 3.794413},
			{-0.855328, 3.791071},
			{-0.856092, 3.787712},
			{-0.856782, 3.784338},
			{-0.857399, 3.780949},
			{-0.857941, 3.777547},
			{-0.858409, 3.774134},
			{-0.858803, 3.770712},
			{-0.859122, 3.767282},
			{-0.859365, 3.763846},
			{-0.859534, 3.760406},
			{-0.859628, 3.756962},
		}...)
	// Validate that a non-default point comparison indicates being inside
	if !s.P[1].PS[3].Inside(s.P[0]) {
		t.Fatalf("target point %v not in s.P[0]", s.P[1].PS[3])
	}
	hits, p1, p2 := crossings(s.P[0], s.P[1])
	if len(hits) != 0 {
		t.Errorf("found unexpected hits %v", hits)
	}
	if len(p1.PS) != len(s.P[0].PS) {
		t.Errorf("p1 is unexpected size: got=%d want=%d", len(p1.PS), len(s.P[0].PS))
	}
	if len(p2.PS) != len(s.P[1].PS) {
		t.Errorf("p2 is unexpected size: got=%d want=%d", len(p2.PS), len(s.P[1].PS))
	}
	aInB, bInA := insider(hits, p1, p2)
	if aInB || !bInA {
		t.Errorf("p1 in p2? %v %v", aInB, bInA)
	}
}

func TestDissolve(t *testing.T) {
	s := &Shape{
		MinX: 101.6096,
		MinY: 64.3607,
		MaxX: 102.2596,
		MaxY: 64.5893,
		Hole: false,
		PS: []Point{
			{101.6346, 64.3857},
			{101.68459999999999, 64.3857},
			{101.6846, 64.49999999999999},
			{101.68459999999999, 64.56429999999999},
			{101.6346, 64.56429999999999},
		},
	}
	s, changed := s.dissolve()
	if len(s.PS) != 4 {
		t.Errorf("unexpected length for s = %v (changed=%v)", s, changed)
	}
}

// Special case Union tests from T font rendering.
func TestGlance(t *testing.T) {
	var ss *Shapes
	ss = ss.Builder([]Point{
		{-0.2727272727, 12.5454545455},
		{-0.2519671452, 12.4410863366},
		{-0.1928473040, 12.3526072415},
		{-0.1043682088, 12.2934874002},
		{-0.0000000000, 12.2727272727},
		{0.1043682088, 12.2934874002},
		{0.1928473040, 12.3526072415},
		{0.2519671452, 12.4410863366},
		{0.2727272727, 12.5454545455},
		{0.2519671452, 12.6498227543},
		{0.1928473040, 12.7383018494},
		{0.1043682088, 12.7974216907},
		{0.0000000000, 12.8181818182},
		{-0.1043682088, 12.7974216907},
		{-0.1928473040, 12.7383018494},
		{-0.2519671452, 12.6498227543},
	}...).Builder([]Point{
		{-0.2727272727, 1.0909090909},
		{0.2727272727, 1.0909090909},
		{0.2727272727, 12.5454545455},
		{-0.2727272727, 12.5454545455},
	}...).Builder([]Point{
		{-3.8181818182, 12.2727272727},
		{3.8181818182, 12.2727272727},
		{3.8181818182, 12.8181818182},
		{-3.8181818182, 12.8181818182},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us := ss.P[0].PS
	expect := []Point{
		{-3.8181818182, 12.2727272727},
		{-0.2727272727, 12.2727272727},
		{-0.2727272727, 1.0909090909},
		{0.2727272727, 1.0909090909},
		{0.2727272727, 12.2727272727},
		{3.8181818182, 12.2727272727},
		{3.8181818182, 12.8181818182},
		{-3.8181818182, 12.8181818182},
	}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}
}

// Special case Union test from a font rendering.
func TestConcaveD(t *testing.T) {
	data := [][]Point{
		[]Point{
			{-1.052632, 3.771930},
			{1.228070, 3.771930},
			{1.228070, 4.087719},
			{-1.052632, 4.087719},
		},
		[]Point{
			{-0.157895, 0.421053},
			{0.157895, 0.421053},
			{0.157895, 3.929825},
			{-0.157895, 3.929825},
		},
		[]Point{
			{0.017544, 0.421053},
			{0.017581, 0.410608},
			{0.333296, 0.410608},
			{0.333333, 0.424053},
			{0.333296, 0.424497},
		},
		[]Point{
			{0.017544, 0.421053},
			{0.333333, 0.421053},
			{0.333333, 3.929825},
			{0.017544, 3.929825},
		},
	}
	var ss *Shapes
	for i, pts := range data {
		ss = ss.Builder(pts...)
		ss.P[len(ss.P)-1].Index = fmt.Sprint(i)
	}
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us := ss.P[0].PS
	expect := []Point{
		{-1.052632, 3.77193},
		{-0.157895, 3.77193},
		{-0.157895, 0.421053},
		{0.017544, 0.421053},
		{0.017581, 0.410608},
		{0.333296, 0.410608},
		{0.333325, 0.421053},
		{0.333333, 0.421053},
		{0.333333, 3.77193},
		{1.22807, 3.77193},
		{1.22807, 4.087719},
		{-1.052632, 4.087719},
	}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; !MatchPoint(got, want) {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}
}

func TestHull(t *testing.T) {
	basic := []Point{
		{1, 1},
		{9, 1},
		{9, 5},
		{1, 5},
	}
	inside := []Point{
		{8, 5},
		{6, 4},
		{7, 3},
		{5, 2},
		{3, 3},
		{4, 4},
		{3, 5},
	}
	// Evaluate the hull for adding that size slice of inside to
	// basic. The hull should always have 4 points and match
	// basic.
	for i := 0; i < len(inside); i++ {
		var s *Shapes
		s = s.Builder(basic[:3]...)
		s.P[0].PS = append(append(s.P[0].PS, inside[:i]...), basic[3])
		hull, insides := s.P[0].Hull()
		if (insides == nil && i != 0) || (insides != nil && len(insides) != i) {
			t.Errorf("[%d] bad hull got=%v with these insides: %v", i, hull, insides)
		}
		if len(hull.PS) != len(basic) {
			t.Errorf("[%d] bad hull got=%v want=%v", i, hull, basic)
		}
		for j, pt := range hull.PS {
			if !MatchPoint(pt, basic[j]) {
				t.Errorf("[%d] hull[%d] mismatch got=%v want=%v", i, j, pt, basic[j])
			}
		}
	}
}

func TestConcaveE(t *testing.T) {
	data := [][]Point{
		[]Point{
			{1, 1},
			{5, 1},
			{5, 3},
			{2, 3},
			{2, 4},
			{5, 4},
			{5, 5},
			{2, 5},
			{2, 6},
			{5, 6},
			{5, 8},
			{1, 8},
		},
		[]Point{
			{3, 2},
			{4, 2},
			{4, 7},
			{3, 7},
		},
	}
	var ss *Shapes
	for _, pts := range data {
		ss = ss.Builder(pts...)
	}
	ss.Union()
	if len(ss.P) != 3 {
		ss.Debug(false)
		t.Fatalf("expecting 3 polygons, but got %d", len(ss.P))
	}
	expect := [][]Point{
		[]Point{
			{1, 1},
			{5, 1},
			{5, 3},
			{4, 3},
			{4, 4},
			{5, 4},
			{5, 5},
			{4, 5},
			{4, 6},
			{5, 6},
			{5, 8},
			{1, 8},
		},
		[]Point{
			{2, 3},
			{2, 4},
			{3, 4},
			{3, 3},
		},
		[]Point{
			{2, 5},
			{2, 6},
			{3, 6},
			{3, 5},
		},
	}
	for j, ex := range expect {
		us := ss.P[j].PS
		if len(us) != len(ex) {
			t.Fatalf("[%d] expecting %d post union points: got=%v, want=%v", j, len(ex), us, ex)
		}
		for i, got := range us {
			if want := ex[i]; !MatchPoint(got, want) {
				t.Errorf("union[%d] point[%d]: got=%v, want=%v", j, i, got, want)
			}
		}
	}
}

// Special case Union tests from T font rendering.
func TestRoundsD(t *testing.T) {
	var ss *Shapes
	ss = ss.Builder([]Point{
		//poly0 =
		{-0.2318181818, 0.6272727273},
		{-0.2307801754, 0.6220543168},
		{-0.2278241834, 0.6176303621},
		{-0.2234002286, 0.6146743700},
		{-0.2181818182, 0.6136363636},
		{-0.2129634077, 0.6146743700},
		{-0.2085394530, 0.6176303621},
		{-0.2055834609, 0.6220543168},
		{-0.2045454545, 0.6272727273},
		{-0.2055834609, 0.6324911377},
		{-0.2085394530, 0.6369150925},
		{-0.2129634077, 0.6398710845},
		{-0.2181818182, 0.6409090909},
		{-0.2234002286, 0.6398710845},
		{-0.2278241834, 0.6369150925},
		{-0.2307801754, 0.6324911377},
	}...).Builder([]Point{
		//poly1 =
		{-0.2318181818, 0.0545454545},
		{-0.2045454545, 0.0545454545},
		{-0.2045454545, 0.6272727273},
		{-0.2318181818, 0.6272727273},
	}...).Builder([]Point{
		//poly3 =
		{-0.2318125583, 0.6268811430},
		{-0.2306251272, 0.6216946922},
		{-0.2275433151, 0.6173574467},
		{-0.2230362999, 0.6145297127},
		{-0.2177902339, 0.6136419872},
		{-0.2126037831, 0.6148294183},
		{-0.2082665376, 0.6179112304},
		{-0.2054388036, 0.6224182455},
		{-0.2045510781, 0.6276643115},
		{-0.2057385092, 0.6328507623},
		{-0.2088203213, 0.6371880079},
		{-0.2133273364, 0.6400157418},
		{-0.2185734024, 0.6409034673},
		{-0.2237598532, 0.6397160362},
		{-0.2280970988, 0.6366342241},
		{-0.2309248327, 0.6321272090},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us := ss.P[0].PS
	expect := []Point{
		{-0.2318181818, 0.0545454545},
		{-0.2045454545, 0.0545454545},
		{-0.2045454545, 0.6272727273},
		{-0.2045842970668152, 0.6274680020638463},
		{-0.2045510781, 0.6276643115},
		{-0.20510192843877695, 0.630070310618795},
		{-0.2055834609, 0.6324911377},
		{-0.20569407513765747, 0.63265668360509},
		{-0.2057385092, 0.6328507623},
		{-0.20716816509595065, 0.6348628151257469},
		{-0.208539453, 0.6369150925},
		{-0.20870499884368962, 0.6370257066953894},
		{-0.2088203213, 0.6371880079},
		{-0.21091113049169333, 0.6384997967222257},
		{-0.2129634077, 0.6398710845},
		{-0.2131586823856626, 0.6399099270505191},
		{-0.2133273364, 0.6400157418},
		{-0.21576099135463303, 0.6404275584949155},
		{-0.2181818182, 0.6409090909},
		{-0.21837709296384633, 0.6408702483331848},
		{-0.2185734024, 0.6409034673},
		{-0.22097940151879678, 0.6403526169612227},
		{-0.2234002286, 0.6398710845},
		{-0.22356577451360943, 0.639760470260392},
		{-0.2237598532, 0.6397160362},
		{-0.22577190476038847, 0.6382863812031446},
		{-0.2278241834, 0.6369150925},
		{-0.22793479771784567, 0.6367495464692996},
		{-0.2280970988, 0.6366342241},
		{-0.22940888714523408, 0.6345434156685652},
		{-0.2307801754, 0.6324911377},
		{-0.23081901795160906, 0.6322958630126001},
		{-0.2309248327, 0.632127209},
		{-0.2313366496448933, 0.6296935528422543},
		{-0.2318181818, 0.6272727273},
	}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}
}

func TestUnion(t *testing.T) {
	var ss *Shapes
	var err error
	ss, err = ss.Append(Point{0, 0}, Point{2, 0}, Point{2, 2}, Point{0, 2})
	if ss == nil || err != nil {
		t.Fatalf("failed to add first square: %v", err)
	}
	if ss.P[0].Hole {
		t.Fatalf("counter-clockwise shape is a hole: %#v", *ss.P[0])
	}
	ss = ss.Builder(Point{1, 1}, Point{1, 3}, Point{3, 3}, Point{3, 1})
	if len(ss.P) != 2 {
		t.Fatalf("failed to add second shape, only %d shapes recorded", len(ss.P))
	}
	if !ss.P[1].Hole {
		t.Fatalf("clockwise shape is not a hole: %#v", *ss.P[1])
	}
	if err = ss.Invert(3); err == nil {
		t.Fatal("invalid polygon shape inversion performed?")
	}
	if err = ss.Invert(1); err != nil {
		t.Fatalf("polygon shape inversion failed: %v", err)
	}
	if ss.P[1].Hole {
		t.Fatalf("counter-clockwise shape is still a hole: %#v", *ss.P[1])
	}
	ss = ss.Builder(Point{0, 4}, Point{2, 4}, Point{2, 6}, Point{0, 6})
	if len(ss.P) != 3 {
		t.Fatalf("failed to add second shape, only %d shapes recorded", len(ss.P))
	}
	if ss.P[2].Hole {
		t.Fatalf("counter-clockwise shape is a hole: %#v", *ss.P[2])
	}
	ss = ss.Builder(Point{1, 5}, Point{3, 5}, Point{3, 7}, Point{1, 7})
	if len(ss.P) != 4 {
		t.Fatalf("failed to add second shape, only %d shapes recorded", len(ss.P))
	}
	if ss.P[3].Hole {
		t.Fatalf("counter-clockwise shape is a hole: %#v", *ss.P[2])
	}
	ss.Union()
	if len(ss.P) != 2 {
		t.Fatalf("post union shape count != 2, got=%d", len(ss.P))
	}
	us := ss.P[0].PS
	if len(us) != 8 {
		t.Fatalf("expecting 8 post union points: got=%v", us)
	}
	expect := []Point{{0, 0}, {2, 0}, {2, 1}, {3, 1}, {3, 3}, {1, 3}, {1, 2}, {0, 2}}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}
	us = ss.P[1].PS
	expect = []Point{{0, 4}, {2, 4}, {2, 5}, {3, 5}, {3, 7}, {1, 7}, {1, 6}, {0, 6}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[1] point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	ss = nil
	ss = ss.Builder([]Point{
		{X: 1, Y: 1},
		{X: 2, Y: 1},
		{X: 2, Y: 2},
		{X: 1, Y: 2},
	}...).Builder([]Point{
		{X: 2, Y: 0},
		{X: 3, Y: 0},
		{X: 3, Y: 2},
		{X: 2, Y: 2},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us = ss.P[0].PS
	expect = []Point{{1, 1}, {2, 1}, {2, 0}, {3, 0}, {3, 2}, {1, 2}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	// Validate coincident heavy overlaps.
	ss = nil
	ss = ss.Builder([]Point{
		{X: 1, Y: 1},
		{X: 2, Y: 1},
		{X: 2, Y: 2},
		{X: 1, Y: 2},
	}...).Builder([]Point{
		{X: 0, Y: 0},
		{X: 1.5, Y: 0},
		{X: 1.5, Y: 1},
		{X: 0, Y: 1},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us = ss.P[0].PS
	expect = []Point{{0, 0}, {1.5, 0}, {1.5, 1}, {2, 1}, {2, 2}, {1, 2}, {1, 1}, {0, 1}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	ss = nil
	ss = ss.Builder([]Point{
		{X: 1, Y: 1},
		{X: 2, Y: 1},
		{X: 2, Y: 2},
		{X: 1, Y: 2},
	}...).Builder([]Point{
		{X: 2, Y: 0},
		{X: 3, Y: 0},
		{X: 3, Y: 3},
		{X: 2, Y: 3},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us = ss.P[0].PS
	expect = []Point{{1, 1}, {2, 1}, {2, 0}, {3, 0}, {3, 3}, {2, 3}, {2, 2}, {1, 2}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	ss = nil
	ss = ss.Builder([]Point{
		{X: 1, Y: 0},
		{X: 2, Y: 0},
		{X: 2, Y: 3},
		{X: 1, Y: 3},
	}...).Builder([]Point{
		{X: 2, Y: 1},
		{X: 3, Y: 1},
		{X: 3, Y: 2},
		{X: 2, Y: 2},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us = ss.P[0].PS
	expect = []Point{{1, 0}, {2, 0}, {2, 1}, {3, 1}, {3, 2}, {2, 2}, {2, 3}, {1, 3}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	// First poly fully contained in second.
	ss = nil
	ss = ss.Builder([]Point{
		{X: 1, Y: 1},
		{X: 2, Y: 1},
		{X: 2, Y: 2},
		{X: 1, Y: 2},
	}...).Builder([]Point{
		{X: 0, Y: 0},
		{X: 3, Y: 0},
		{X: 3, Y: 3},
		{X: 0, Y: 3},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us = ss.P[0].PS
	expect = []Point{{0, 0}, {3, 0}, {3, 3}, {0, 3}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	// first poly subset of second against corner.
	ss = nil
	ss = ss.Builder([]Point{
		{X: 0, Y: 0},
		{X: 2, Y: 0},
		{X: 2, Y: 2},
		{X: 0, Y: 2},
	}...).Builder([]Point{
		{X: 0, Y: 0},
		{X: 3, Y: 0},
		{X: 3, Y: 3},
		{X: 0, Y: 3},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us = ss.P[0].PS
	expect = []Point{{0, 0}, {3, 0}, {3, 3}, {0, 3}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	ss = nil
	ss = ss.Builder([]Point{
		{X: 0, Y: 0},
		{X: 3, Y: 0},
		{X: 3, Y: 1},
		{X: 0, Y: 1},
	}...).Builder([]Point{
		{X: 2, Y: 0},
		{X: 4, Y: 0},
		{X: 4, Y: 2},
		{X: 2, Y: 2},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us = ss.P[0].PS
	expect = []Point{{0, 0}, {4, 0}, {4, 2}, {2, 2}, {2, 1}, {0, 1}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	ss = nil
	ss = ss.Builder([]Point{
		{X: 0, Y: 0},
		{X: 5, Y: 0},
		{X: 5, Y: 1},
		{X: 0, Y: 1},
	}...).Builder([]Point{
		{X: 1, Y: 2},
		{X: 5, Y: 2},
		{X: 5, Y: 3},
		{X: 1, Y: 3},
	}...).Builder([]Point{
		{X: 4, Y: 0},
		{X: 5, Y: 0},
		{X: 5, Y: 3},
		{X: 4, Y: 3},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Errorf("expecting a single poly, but got %d", len(ss.P))
		for i := 0; i < len(ss.P); i++ {
			t.Errorf("P[%d] = %#v", i, *ss.P[i])
		}
	}
	us = ss.P[0].PS
	expect = []Point{{0, 0}, {5, 0}, {5, 3}, {1, 3}, {1, 2}, {4, 2}, {4, 1}, {0, 1}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	ss = nil
	ss = ss.Builder([]Point{
		{X: 0.0000002, Y: 2},
		{X: 1, Y: 2},
		{X: 1, Y: 3},
		{X: 0, Y: 3},
	}...).Builder([]Point{
		{X: 0.0000001, Y: 2},
		{X: 1, Y: 1},
		{X: 2, Y: 2},
		{X: 1, Y: 3},
	}...)
	ss.Union()
	if len(ss.P) != 1 {
		t.Fatalf("expecting a single poly, but got %d", len(ss.P))
	}
	us = ss.P[0].PS
	expect = []Point{{0, 3}, {0.0000002, 2}, {1, 1}, {2, 2}, {1, 3}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	ss = nil
	ss = ss.Builder([]Point{
		{93.6, 72.6},
		{93.7, 72.7},
		{92.2, 73.7},
	}...).Builder([]Point{
		{93.0, 73.7},
		{93.0, 73.4},
		{93.6, 74.3},
	}...)
	ss.Union()
	if len(ss.P) != 2 {
		t.Fatalf("expecting two polys, but got %d", len(ss.P))
	}
	us = ss.P[0].PS
	expect = []Point{{92.2, 73.7}, {93.6, 72.6}, {93.7, 72.7}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union[0] points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[0] point[%d]: got=%v, want=%v", i, got, want)
		}
	}
	us = ss.P[1].PS
	expect = []Point{{93.0, 73.4}, {93.6, 74.3}, {93.0, 73.7}}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union[1] points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; got != want {
			t.Errorf("union[1] point[%d]: got=%v, want=%v", i, got, want)
		}
	}
}

func TestVoids(t *testing.T) {
	var ss *Shapes
	ss = ss.Builder([]Point{
		{0, 0}, {4, 0}, {4, 2}, {2, 2}, {2, 4}, {0, 4},
	}...).Builder([]Point{
		{1, 3}, {3, 3}, {3, 1}, {5, 1}, {5, 5}, {1, 5},
	}...)
	ss.Union()
	if len(ss.P) != 2 {
		t.Fatalf("expecting two polys, but got %d", len(ss.P))
	}
	failed := ss.P[0].Hole || !ss.P[1].Hole
	if failed {
		for i, p := range ss.P {
			t.Errorf("p[%d] = %v", i, p)
		}
	}
}

func TestIntersect(t *testing.T) {
	vs := []struct {
		a, b, c, d, at  Point
		hit, left, hold bool
	}{
		{
			a:    Point{3.625877192982456, 0.0429824561403509},
			b:    Point{3.625877192982456, -0.01842105263157895},
			c:    Point{3.6258784326361444, 0.0429824561403509},
			d:    Point{3.6258776107085073, 0.042830519685738255},
			hit:  false,
			left: false,
			hold: true,
		},
		{
			a:    Point{X: -1.3858140320392893, Y: 4.098364906610094},
			b:    Point{X: -1.3858136707313797, Y: 4.0983582887262955},
			c:    Point{X: -1.3858136707313797, Y: 4.0983582887262955},
			d:    Point{X: -1.3858136707313797, Y: 4.0983539166011305},
			hit:  true,
			left: false,
			hold: true,
			at:   Point{X: -1.3858136707313797, Y: 4.0983582887262955},
		},
		{
			a:    Point{X: 0.0, Y: 0.0},
			b:    Point{X: 1.0, Y: 0.0},
			c:    Point{X: 0.1, Y: 0.1},
			d:    Point{X: 0.1, Y: 1.0},
			hit:  false,
			left: true,
			hold: true,
			at:   Point{X: 92.062470, Y: 72.33},
		},
		{
			a:    Point{X: 0.1, Y: 0.1},
			b:    Point{X: 0.1, Y: 1.0},
			c:    Point{X: 1.0, Y: 0.0},
			d:    Point{X: 0.0, Y: 0.0},
			hit:  false,
			left: false,
			hold: false,
			at:   Point{X: 92.062470, Y: 72.33},
		},
		{
			a:    Point{X: 92.0432020322183, Y: 72.27706055336469},
			b:    Point{X: 92.09680528764137, Y: 72.42433428724885},
			c:    Point{X: 91.44, Y: 72.33},
			d:    Point{X: 96.1048, Y: 72.33},
			hit:  true,
			hold: true,
			left: false,
			at:   Point{X: 92.062470, Y: 72.33},
		},
		{
			a:    Point{92.60249999999999, 76.16},
			b:    Point{100.32606320135385, 76.16},
			c:    Point{94.39130827905281, 75.99996093389592},
			d:    Point{94.4025, 76.16},
			hit:  true,
			hold: false,
			left: true,
			at:   Point{94.4025, 76.16},
		},
	}
	for i, v := range vs {
		hit, left, hold, at := intersect(v.a, v.b, v.c, v.d)
		if hold != v.hold {
			t.Errorf("test=%d: hold got=%v, want=%v", i, hold, v.hold)
		}
		if left != v.left {
			t.Errorf("test=%d: left got=%v, want=%v", i, left, v.left)
		}
		if hit != v.hit {
			t.Fatalf("test=%d: hit got=%v, want=%v", i, hit, v.hit)
		}
		if !hit {
			continue
		}
		if !MatchPoint(v.at, at) {
			t.Errorf("test=%d got=%v, want=%v", i, at, v.at)
		}
	}
}

// TestClock looks for intersections at (0,0) for two hands that pass
// through this point, at different angles.
func TestClock(t *testing.T) {
	const N = 13
	var zero Point
	aI, aJ := math.Pi*2/N, math.Pi*2/(N+2)
	for i := 0; i < N; i++ {
		angI := aI * float64(i)
		aA := Point{
			X: math.Cos(angI),
			Y: math.Sin(angI),
		}
		aB := zero.AddX(aA, -4)
		for j := 1; j < N; j++ {
			angJ := aJ * float64(j)
			aC := Point{
				X: 6 * math.Cos(angJ),
				Y: 6 * math.Sin(angJ),
			}
			aD := zero.AddX(aC, -0.5)
			hit, left, hold, at := intersect(aA, aB, aC, aD)
			if !hit || !MatchPoint(zero, at) {
				t.Errorf("[%d,%d] %v %v %v %v -> %v %v %v %v", i, j, aA, aB, aC, aD, hit, left, hold, at)
			}
		}
	}
}

func TestTrace(t *testing.T) {
	pts := [][]Point{
		[]Point{{X: 97.35, Y: 68.58}, {X: 97.23, Y: 68.80}, {X: 96.98, Y: 68.80}, {X: 96.85, Y: 68.58}, {X: 96.98, Y: 68.36}, {X: 97.23, Y: 68.36}},
		[]Point{{X: 91.44, Y: 68.33}, {X: 97.10, Y: 68.33}, {X: 97.10, Y: 68.83}, {X: 91.44, Y: 68.83}},
		[]Point{{X: 91.69, Y: 68.58}, {X: 91.57, Y: 68.80}, {X: 91.32, Y: 68.80}, {X: 91.19, Y: 68.58}, {X: 91.32, Y: 68.36}, {X: 91.57, Y: 68.36}},
	}
	var s *Shapes
	for i, ps := range pts {
		var err error
		s, err = s.Append(ps...)
		if err != nil {
			t.Fatalf("shape=%d failed import: %v", i, err)
		}
		s.Union()
		if len(s.P) != 1 {
			t.Fatalf("after shape=%d unioned, got=%d shapes, want=1: %v", i, len(s.P), s.P)
		}
	}
	us := s.P[0].PS
	expect := []Point{
		{X: 91.19, Y: 68.58},
		{X: 91.32, Y: 68.36},
		{X: 91.44, Y: 68.36},
		{X: 91.44, Y: 68.33},
		{X: 97.10, Y: 68.33},
		{X: 97.10, Y: 68.36},
		{X: 97.23, Y: 68.36},
		{X: 97.35, Y: 68.58},
		{X: 97.23, Y: 68.80},
		{X: 97.10, Y: 68.80},
		{X: 97.10, Y: 68.83},
		{X: 91.44, Y: 68.83},
		{X: 91.44, Y: 68.80},
		{X: 91.32, Y: 68.80},
	}
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points: got=%v, want=%v", len(expect), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; !MatchPoint(got, want) {
			t.Errorf("point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	pts = [][]Point{
		[]Point{
			{X: 91.190000, Y: 74.580000},
			{X: 91.237746, Y: 74.433054},
			{X: 91.362746, Y: 74.342236},
			{X: 91.440000, Y: 74.342236},
			{X: 91.440000, Y: 74.330000},
			{X: 96.180000, Y: 74.330000},
			{X: 96.180000, Y: 74.342236},
			{X: 96.257254, Y: 74.342236},
			{X: 96.382254, Y: 74.433054},
			{X: 96.430000, Y: 74.580000},
			{X: 96.382254, Y: 74.726946},
			{X: 96.257254, Y: 74.817764},
			{X: 96.180000, Y: 74.817764},
			{X: 96.180000, Y: 74.830000},
			{X: 91.440000, Y: 74.830000},
			{X: 91.440000, Y: 74.817764},
			{X: 91.362746, Y: 74.817764},
			{X: 91.237746, Y: 74.726946},
		},
		[]Point{
			{X: 95.930000, Y: 74.580000},
			{X: 95.977746, Y: 74.433054},
			{X: 96.009780, Y: 74.409780},
			{X: 96.003223, Y: 74.403223},
			{X: 96.343223, Y: 74.063223},
			{X: 96.349780, Y: 74.069780},
			{X: 96.442746, Y: 74.002236},
			{X: 96.597254, Y: 74.002236},
			{X: 96.722254, Y: 74.093054},
			{X: 96.770000, Y: 74.240000},
			{X: 96.722254, Y: 74.386946},
			{X: 96.690220, Y: 74.410220},
			{X: 96.696777, Y: 74.416777},
			{X: 96.356777, Y: 74.756777},
			{X: 96.350220, Y: 74.750220},
			{X: 96.257254, Y: 74.817764},
			{X: 96.102746, Y: 74.817764},
			{X: 95.977746, Y: 74.726946},
		},
	}
	s = nil
	for i, ps := range pts {
		var err error
		s, err = s.Append(ps...)
		if err != nil {
			t.Fatalf("shape=%d failed import: %v", i, err)
		}
		s.Union()
		if len(s.P) != 1 {
			t.Fatalf("after shape=%d unioned, got=%d shapes, want=1: %v", i, len(s.P), s.P)
		}
	}
	expect = []Point{
		{X: 91.19, Y: 74.58},
		{X: 91.237746, Y: 74.433054},
		{X: 91.362746, Y: 74.342236},
		{X: 91.44, Y: 74.342236},
		{X: 91.44, Y: 74.33},
		{X: 96.07644599999999, Y: 74.33},
		{X: 96.343223, Y: 74.063223},
		{X: 96.34978, Y: 74.06978},
		{X: 96.442746, Y: 74.002236},
		{X: 96.597254, Y: 74.002236},
		{X: 96.722254, Y: 74.093054},
		{X: 96.77, Y: 74.24},
		{X: 96.722254, Y: 74.386946},
		{X: 96.69022, Y: 74.41022},
		{X: 96.696777, Y: 74.416777},
		{X: 96.356777, Y: 74.756777},
		{X: 96.35022006399838, Y: 74.75022006399838},
		{X: 96.257254, Y: 74.817764},
		{X: 96.18, Y: 74.817764},
		{X: 96.18, Y: 74.83},
		{X: 91.44, Y: 74.83},
		{X: 91.44, Y: 74.817764},
		{X: 91.362746, Y: 74.817764},
		{X: 91.237746, Y: 74.726946},
	}
	us = s.P[0].PS
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points, but see=%d points: got=%#v, want=%#v", len(expect), len(us), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; !MatchPoint(got, want) {
			t.Errorf("point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	pts = [][]Point{
		[]Point{
			{X: 90.7695641085242, Y: 72.50163728296546},
			{X: 90.80570748096952, Y: 72.34913640325517},
			{X: 90.87604572729627, Y: 72.2090814398022},
			{X: 90.9767868944386, Y: 72.08902279193819},
			{X: 91.10249999999999, Y: 71.9954328524455},
			{X: 91.24640781792002, Y: 71.93335707918705},
			{X: 91.40075224048543, Y: 71.9061419931669},
			{X: 91.55721251992517, Y: 71.91525476671676},
			{X: 91.70735384207643, Y: 71.96020412785582},
			{X: 91.84308204939938, Y: 72.03856684489034},
			{X: 91.9570799991053, Y: 72.14611836346158},
			{X: 92.0432020322183, Y: 72.27706055336469},
			{X: 92.09680528764137, Y: 72.42433428724885},
			{X: 92.115, Y: 72.58},
			{X: 92.09680528764137, Y: 72.73566571275114},
			{X: 92.0432020322183, Y: 72.8829394466353},
			{X: 91.9570799991053, Y: 73.01388163653841},
			{X: 91.84308204939938, Y: 73.12143315510966},
			{X: 91.70735384207643, Y: 73.19979587214418},
			{X: 91.55721251992517, Y: 73.24474523328324},
			{X: 91.40075224048543, Y: 73.2538580068331},
			{X: 91.24640781792002, Y: 73.22664292081295},
			{X: 91.10249999999999, Y: 73.1645671475545},
			{X: 90.9767868944386, Y: 73.0709772080618},
			{X: 90.87604572729627, Y: 72.95091856019779},
			{X: 90.80570748096952, Y: 72.81086359674482},
			{X: 90.7695641085242, Y: 72.65836271703454},
		},
		[]Point{
			{X: 91.19, Y: 72.58},
			{X: 91.23774575140627, Y: 72.43305368692688},
			{X: 91.36274575140627, Y: 72.34223587092622},
			{X: 91.44, Y: 72.3422358709262},
			{X: 91.44, Y: 72.33},
			{X: 96.1048, Y: 72.33},
			{X: 96.1048, Y: 72.34223587092622},
			{X: 96.18205424859373, Y: 72.3422358709262},
			{X: 96.30705424859373, Y: 72.43305368692688},
			{X: 96.3548, Y: 72.58},
			{X: 96.30705424859373, Y: 72.72694631307311},
			{X: 96.18205424859373, Y: 72.81776412907378},
			{X: 96.1048, Y: 72.8177641290738},
			{X: 96.1048, Y: 72.83},
			{X: 91.44, Y: 72.83},
			{X: 91.44, Y: 72.81776412907378},
			{X: 91.36274575140627, Y: 72.8177641290738},
			{X: 91.23774575140627, Y: 72.72694631307311},
		},
	}
	s = nil
	for i, ps := range pts {
		var err error
		s, err = s.Append(ps...)
		if err != nil {
			t.Fatalf("shape=%d failed import: %v", i, err)
		}
		s.Union()
		if len(s.P) != 1 {
			t.Fatalf("after shape=%d unioned, got=%d shapes, want=1: %v", i, len(s.P), s.P)
		}
	}
	expect = []Point{
		{X: 90.7695641085242, Y: 72.50163728296546},
		{X: 90.80570748096952, Y: 72.34913640325517},
		{X: 90.87604572729627, Y: 72.2090814398022},
		{X: 90.9767868944386, Y: 72.08902279193819},
		{X: 91.10249999999999, Y: 71.9954328524455},
		{X: 91.24640781792002, Y: 71.93335707918705},
		{X: 91.40075224048543, Y: 71.9061419931669},
		{X: 91.55721251992517, Y: 71.91525476671676},
		{X: 91.70735384207643, Y: 71.96020412785582},
		{X: 91.84308204939938, Y: 72.03856684489034},
		{X: 91.9570799991053, Y: 72.14611836346158},
		{X: 92.0432020322183, Y: 72.27706055336469},
		{X: 92.06247041501207, Y: 72.32999999999998},
		{X: 96.1048, Y: 72.33},
		{X: 96.1048, Y: 72.34223587092622},
		{X: 96.18205424859373, Y: 72.3422358709262},
		{X: 96.30705424859373, Y: 72.43305368692688},
		{X: 96.3548, Y: 72.58},
		{X: 96.30705424859373, Y: 72.72694631307311},
		{X: 96.18205424859373, Y: 72.81776412907378},
		{X: 96.1048, Y: 72.8177641290738},
		{X: 96.1048, Y: 72.83},
		{X: 92.06247041501207, Y: 72.82999999999998},
		{X: 92.0432020322183, Y: 72.8829394466353},
		{X: 91.9570799991053, Y: 73.01388163653841},
		{X: 91.84308204939938, Y: 73.12143315510966},
		{X: 91.70735384207643, Y: 73.19979587214418},
		{X: 91.55721251992517, Y: 73.24474523328324},
		{X: 91.40075224048543, Y: 73.2538580068331},
		{X: 91.24640781792002, Y: 73.22664292081295},
		{X: 91.10249999999999, Y: 73.1645671475545},
		{X: 90.9767868944386, Y: 73.0709772080618},
		{X: 90.87604572729627, Y: 72.95091856019779},
		{X: 90.80570748096952, Y: 72.81086359674482},
		{X: 90.7695641085242, Y: 72.65836271703454},
	}
	us = s.P[0].PS
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points, but see=%d points: got=%#v, want=%#v", len(expect), len(us), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; !MatchPoint(got, want) {
			t.Errorf("point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	pts = [][]Point{
		[]Point{
			{X: 90.765, Y: 67.905},
			{X: 92.115, Y: 67.905},
			{X: 92.115, Y: 68.33},
			{X: 97.1, Y: 68.33},
			{X: 97.1, Y: 68.34223587092622},
			{X: 97.17725424859373, Y: 68.3422358709262},
			{X: 97.30225424859373, Y: 68.43305368692688},
			{X: 97.35, Y: 68.58},
			{X: 97.30225424859373, Y: 68.72694631307311},
			{X: 97.17725424859373, Y: 68.81776412907378},
			{X: 97.1, Y: 68.8177641290738},
			{X: 97.1, Y: 68.83},
			{X: 92.115, Y: 68.83},
			{X: 92.115, Y: 69.255},
			{X: 90.765, Y: 69.255},
		},
		[]Point{
			{X: 96.85, Y: 68.58},
			{X: 96.89774575140626, Y: 68.43305368692688},
			{X: 97.02274575140626, Y: 68.34223587092622},
			{X: 97.17725424859373, Y: 68.3422358709262},
			{X: 97.27022032262697, Y: 68.40977967737305},
			{X: 97.27677669529663, Y: 68.40322330470336},
			{X: 97.91177669529664, Y: 69.03822330470337},
			{X: 97.90522032262695, Y: 69.04477967737304},
			{X: 97.93725424859373, Y: 69.06805368692689},
			{X: 97.985, Y: 69.215},
			{X: 97.93725424859373, Y: 69.36194631307312},
			{X: 97.81225424859373, Y: 69.45276412907378},
			{X: 97.65774575140627, Y: 69.45276412907378},
			{X: 97.56477967737304, Y: 69.38522032262695},
			{X: 97.55822330470336, Y: 69.39177669529664},
			{X: 96.92322330470336, Y: 68.75677669529664},
			{X: 96.92977967737303, Y: 68.75022032262696},
			{X: 96.89774575140626, Y: 68.72694631307311},
		},
	}
	s = nil
	for i, ps := range pts {
		var err error
		s, err = s.Append(ps...)
		if err != nil {
			t.Fatalf("shape=%d failed import: %v", i, err)
		}
		s.Union()
		if len(s.P) != 1 {
			t.Fatalf("after shape=%d unioned, got=%d shapes, want=1: %v", i, len(s.P), s.P)
		}
	}
	expect = []Point{
		{X: 90.765, Y: 67.905},
		{X: 92.115, Y: 67.905},
		{X: 92.115, Y: 68.33},
		{X: 97.1, Y: 68.33},
		{X: 97.1, Y: 68.34223587092622},
		{X: 97.17725424859373, Y: 68.3422358709262},
		{X: 97.27022032262697, Y: 68.40977967737305},
		{X: 97.27677669529663, Y: 68.40322330470336},
		{X: 97.91177669529664, Y: 69.03822330470337},
		{X: 97.90522032262695, Y: 69.04477967737304},
		{X: 97.93725424859373, Y: 69.06805368692689},
		{X: 97.985, Y: 69.215},
		{X: 97.93725424859373, Y: 69.36194631307312},
		{X: 97.81225424859373, Y: 69.45276412907378},
		{X: 97.65774575140627, Y: 69.45276412907378},
		{X: 97.56477967737304, Y: 69.38522032262695},
		{X: 97.55822330470336, Y: 69.39177669529664},
		{X: 96.99644660940672, Y: 68.83},
		{X: 92.115, Y: 68.83},
		{X: 92.115, Y: 69.255},
		{X: 90.765, Y: 69.255},
	}
	us = s.P[0].PS
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points, but see=%d points: got=%#v, want=%#v", len(expect), len(us), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; !MatchPoint(got, want) {
			t.Errorf("point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	pts = [][]Point{
		[]Point{
			{X: 93.0525, Y: 76.16},
			{X: 93.11107864376268, Y: 76.01857864376268},
			{X: 93.2525, Y: 75.96},
			{X: 93.39392135623731, Y: 76.01857864376268},
			{X: 93.4525, Y: 76.16},
			{X: 93.39392135623731, Y: 76.30142135623731},
			{X: 93.2525, Y: 76.36},
			{X: 93.11107864376268, Y: 76.30142135623731},
		},
		[]Point{
			{X: 93.1110786437627, Y: 76.01857864376268},
			{X: 93.8360786437627, Y: 75.29357864376269},
			{X: 94.11892135623731, Y: 75.57642135623732},
			{X: 93.3939213562373, Y: 76.30142135623731},
		},
		[]Point{
			{X: 93.7775, Y: 75.435},
			{X: 93.83607864376269, Y: 75.29357864376269},
			{X: 93.9775, Y: 75.235},
			{X: 94.11892135623732, Y: 75.29357864376269},
			{X: 94.17750000000001, Y: 75.435},
			{X: 94.11892135623732, Y: 75.57642135623732},
			{X: 93.9775, Y: 75.635},
			{X: 93.83607864376269, Y: 75.57642135623732},
		},
	}
	s = nil
	for i, ps := range pts {
		var err error
		s, err = s.Append(ps...)
		if err != nil {
			t.Fatalf("shape=%d failed import: %v", i, err)
		}
		s.Union()
		if len(s.P) != 1 {
			t.Fatalf("after shape=%d unioned, got=%d shapes, want=1: %v", i, len(s.P), s.P)
		}
	}
	expect = []Point{
		{X: 93.0525, Y: 76.16},
		{X: 93.11107864376268, Y: 76.01857864376268},
		{X: 93.8360786437627, Y: 75.29357864376269},
		{X: 93.9775, Y: 75.235},
		{X: 94.11892135623732, Y: 75.29357864376269},
		{X: 94.17750000000001, Y: 75.435},
		{X: 94.11892135623731, Y: 75.57642135623732},
		{X: 93.39392135623731, Y: 76.30142135623731},
		{X: 93.2525, Y: 76.36},
		{X: 93.11107864376268, Y: 76.30142135623731},
	}
	us = s.P[0].PS
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points, but see=%d points: got=%#v, want=%#v", len(expect), len(us), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; !MatchPoint(got, want) {
			t.Errorf("point[%d]: got=%v, want=%v", i, got, want)
		}
	}

	pts = [][]Point{
		[]Point{
			{101.7525, 64.1893},
			{101.76714466094067, 64.15394466094068},
			{101.8025, 64.1393},
			{101.81027604609508, 64.14252094375422},
			{101.83785533905932, 64.15394466094068},
			{101.85249999999999, 64.1893},
			{101.83785533905932, 64.22465533905932},
			{101.8025, 64.2393},
			{101.7947239539049, 64.23607905624579},
			{101.76714466094067, 64.22465533905932},
		},
		[]Point{
			{101.79430104443772, 64.2386231905668},
			{101.7947239539049, 64.23607905624579},
			{101.81027604609508, 64.14252094375422},
			{101.81069895556227, 64.13997680943321},
			{101.92499895556227, 64.1589768094332},
			{101.90860104443772, 64.25762319056679},
		},
	}
	s = nil
	for i, ps := range pts {
		var err error
		s, err = s.Append(ps...)
		if err != nil {
			t.Fatalf("shape=%d failed import: %v", i, err)
		}
		s.Union()
		if err := s.chk(0); err != nil {
			t.Fatalf("shape=%d failed to correct bounding box: %v", i, err)
		}
		if len(s.P) != 1 {
			t.Fatalf("after shape=%d unioned, got=%d shapes, want=1: %v", i, len(s.P), s.P)
		}
	}
	expect = []Point{
		{X: 101.7525, Y: 64.1893},
		{X: 101.76714466094067, Y: 64.15394466094068},
		{X: 101.8025, Y: 64.1393},
		{X: 101.81027604609508, Y: 64.14252094375422},
		{X: 101.81069895556227, Y: 64.13997680943321},
		{X: 101.92499895556227, Y: 64.1589768094332},
		{X: 101.90860104443772, Y: 64.25762319056679},
		{X: 101.79430104443772, Y: 64.2386231905668},
		{X: 101.7947239539049, Y: 64.23607905624579},
		{X: 101.76714466094067, Y: 64.22465533905932},
	}
	us = s.P[0].PS
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points, but see=%d points: got=%#v, want=%#v", len(expect), len(us), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; !MatchPoint(got, want) {
			t.Errorf("point[%d]: got=%v, want=%v", i, got, want)
		}
	}
}

func TestMultiUnion(t *testing.T) {
	pts := [][]Point{
		[]Point{
			{102.02893679864614, 75.27038988683911},
			{102.0529527410619, 75.17135781555598},
			{102.11738387113262, 75.07488387113261},
			{102.21385781555601, 75.0104527410619},
			{102.31288988683914, 74.98643679864615},
			{103.99211011316088, 74.98643679864615},
			{104.09114218444398, 75.01045274106188},
			{104.18761612886738, 75.0748838711326},
			{104.2520472589381, 75.17135781555601},
			{104.27606320135385, 75.27038988683914},
			{104.27606320135385, 75.59961011316085},
			{104.25204725893812, 75.69864218444397},
			{104.18761612886739, 75.79511612886739},
			{104.09114218444398, 75.85954725893812},
			{103.99211011316088, 75.88356320135385},
			{102.31288988683914, 75.88356320135385},
			{102.21385781555601, 75.85954725893811},
			{102.1173838711326, 75.79511612886738},
			{102.05295274106189, 75.698642184444},
			{102.02893679864614, 75.59961011316088},
		},
		[]Point{
			{102.81391807012331, 75.435},
			{102.91308642139695, 75.19558642139695},
			{103.12379874257262, 75.09070903506165},
			{107.35620125742739, 75.09070903506165},
			{107.56691357860305, 75.19558642139695},
			{107.6660819298767, 75.435},
			{107.56691357860305, 75.67441357860305},
			{107.35620125742739, 75.77929096493835},
			{103.12379874257262, 75.77929096493835},
			{102.91308642139695, 75.67441357860305},
		},
		[]Point{
			{106.9053013422012, 76.07978005519425},
			{106.92763025915612, 75.92090155555957},
			{106.9718534860962, 75.76667683517547},
			{107.03711026821223, 75.62010770279622},
			{107.12213045646881, 75.48404695986365},
			{107.22525922961054, 75.36114287397216},
			{107.34448930337548, 75.25378763335226},
			{107.47749999999999, 75.1640707856479},
			{107.6217024175717, 75.0937385672482},
			{107.77428982006037, 75.0441599147826},
			{107.93229226724219, 75.01629982032648},
			{108.09263442120788, 75.01070054892804},
			{108.25219540431696, 75.02747108403595},
			{108.40786954353118, 75.06628500626057},
			{108.55662681880743, 75.12638684675595},
			{108.69557183899136, 75.2066067915617},
			{108.82200019731268, 75.30538345070099},
			{108.93345110958683, 75.42079424886047},
			{109.02775531057989, 75.5505928461318},
			{109.10307727628899, 75.69225286046283},
			{109.15795095032907, 75.84301704081045},
			{109.1913082790528, 75.99995093389592},
			{109.2025, 76.16},
			{109.1913082790528, 76.32004906610408},
			{109.15795095032907, 76.47698295918954},
			{109.10307727628899, 76.62774713953716},
			{109.02775531057989, 76.76940715386819},
			{108.93345110958683, 76.89920575113952},
			{108.82200019731268, 77.014616549299},
			{108.69557183899136, 77.1133932084383},
			{108.55662681880743, 77.19361315324404},
			{108.40786954353119, 77.25371499373942},
			{108.25219540431696, 77.29252891596404},
			{108.09263442120788, 77.30929945107195},
			{107.93229226724219, 77.30370017967351},
			{107.77428982006037, 77.2758400852174},
			{107.6217024175717, 77.2262614327518},
			{107.47749999999999, 77.1559292143521},
			{107.34448930337548, 77.06621236664773},
			{107.22525922961054, 76.95885712602784},
			{107.12213045646881, 76.83595304013635},
			{107.03711026821223, 76.69989229720377},
			{106.9718534860962, 76.55332316482452},
			{106.92763025915612, 76.39909844444043},
			{106.9053013422012, 76.24021994480574},
		},
		[]Point{
			{102.02893679864614, 76.54038988683912},
			{102.05295274106189, 76.441357815556},
			{102.1173838711326, 76.34488387113262},
			{102.21385781555601, 76.2804527410619},
			{102.31288988683914, 76.25643679864615},
			{103.99211011316088, 76.25643679864615},
			{104.09114218444398, 76.28045274106188},
			{104.18761612886739, 76.34488387113261},
			{104.25204725893812, 76.44135781555603},
			{104.27606320135385, 76.54038988683915},
			{104.27606320135385, 76.86961011316086},
			{104.2520472589381, 76.968642184444},
			{104.18761612886738, 77.0651161288674},
			{104.09114218444398, 77.12954725893812},
			{103.99211011316088, 77.15356320135385},
			{102.31288988683914, 77.15356320135385},
			{102.21385781555601, 77.1295472589381},
			{102.11738387113262, 77.06511612886739},
			{102.0529527410619, 76.96864218444402},
			{102.02893679864614, 76.86961011316089},
		},
	}
	var s *Shapes
	for i, ps := range pts {
		var err error
		s, err = s.Append(ps...)
		if err != nil {
			t.Fatalf("shape=%d failed import: %v", i, err)
		}
	}
	s.Union()
	if len(s.P) != 2 {
		t.Errorf("expecting 2 polygons to survive, see %d", len(s.P))
	}
	expect := []Point{
		{102.02893679864614, 75.27038988683911},
		{102.0529527410619, 75.17135781555598},
		{102.11738387113262, 75.07488387113261},
		{102.21385781555601, 75.0104527410619},
		{102.31288988683914, 74.98643679864615},
		{103.99211011316088, 74.98643679864615},
		{104.09114218444398, 75.01045274106188},
		{104.18761612886738, 75.0748838711326},
		{104.19818512966441, 75.09070903506166},
		{107.35620125742739, 75.09070903506165},
		{107.49067961679965, 75.1576426570299},
		{107.6217024175717, 75.0937385672482},
		{107.77428982006037, 75.0441599147826},
		{107.93229226724219, 75.01629982032648},
		{108.09263442120788, 75.01070054892804},
		{108.25219540431696, 75.02747108403595},
		{108.40786954353118, 75.06628500626057},
		{108.55662681880743, 75.12638684675595},
		{108.69557183899136, 75.2066067915617},
		{108.82200019731268, 75.30538345070099},
		{108.93345110958683, 75.42079424886047},
		{109.02775531057989, 75.5505928461318},
		{109.10307727628899, 75.69225286046283},
		{109.15795095032907, 75.84301704081045},
		{109.1913082790528, 75.99995093389592},
		{109.2025, 76.16},
		{109.1913082790528, 76.32004906610408},
		{109.15795095032907, 76.47698295918954},
		{109.10307727628899, 76.62774713953716},
		{109.02775531057989, 76.76940715386819},
		{108.93345110958683, 76.89920575113952},
		{108.82200019731268, 77.014616549299},
		{108.69557183899136, 77.1133932084383},
		{108.55662681880743, 77.19361315324404},
		{108.40786954353119, 77.25371499373942},
		{108.25219540431696, 77.29252891596404},
		{108.09263442120788, 77.30929945107195},
		{107.93229226724219, 77.30370017967351},
		{107.77428982006037, 77.2758400852174},
		{107.6217024175717, 77.2262614327518},
		{107.47749999999999, 77.1559292143521},
		{107.34448930337548, 77.06621236664773},
		{107.22525922961054, 76.95885712602784},
		{107.12213045646881, 76.83595304013635},
		{107.03711026821223, 76.69989229720377},
		{106.9718534860962, 76.55332316482452},
		{106.92763025915612, 76.39909844444043},
		{106.9053013422012, 76.24021994480574},
		{106.9053013422012, 76.07978005519425},
		{106.92763025915612, 75.92090155555957},
		{106.96823644259132, 75.77929096493835},
		{104.19818512966441, 75.77929096493835},
		{104.18761612886739, 75.79511612886739},
		{104.09114218444398, 75.85954725893812},
		{103.99211011316088, 75.88356320135385},
		{102.31288988683914, 75.88356320135385},
		{102.21385781555601, 75.85954725893811},
		{102.1173838711326, 75.79511612886738},
		{102.05295274106189, 75.698642184444},
		{102.02893679864614, 75.59961011316088},
	}
	us := s.P[0].PS
	if len(us) != len(expect) {
		t.Fatalf("expecting %d post union points, but see=%d points: got=%#v, want=%#v", len(expect), len(us), us, expect)
	}
	for i, got := range us {
		if want := expect[i]; !MatchPoint(got, want) {
			t.Errorf("point[%d]: got=%v, want=%v", i, got, want)
		}
	}
}

func TestInflate(t *testing.T) {
	var s *Shapes
	s = s.Builder([]Point{{1, 1}, {2, 1}, {2, 2}, {1, 2}}...)
	if err := s.Inflate(0, 2); err != nil {
		t.Fatalf("unable to inflate shape 0 by 1: %v", err)
	}
	expect := []Point{{0, 0}, {3, 0}, {3, 3}, {0, 3}}
	for i, got := range s.P[0].PS {
		if want := expect[i]; !MatchPoint(got, want) {
			t.Errorf("inflated point[%d]: got=%v, want=%v", i, got, want)
		}
	}
}

func TestNarrows(t *testing.T) {
	ts := [][]Point{
		{
			// not anti-parallel
			{0, 0}, {10, 0}, {3, 1}, {7, 1},
		},
		{
			{0, 0}, {10, 0}, {7, 1}, {3, 1},
			{2, 0}, {8, 0}, {7, 1}, {3, 1},
		},
		{
			{0, 0}, {0, 10}, {1, 7}, {1, 3},
			{0, 2}, {0, 8}, {1, 7}, {1, 3},
		},
		{
			{0, 0}, {0, 10}, {0, 10}, {4, 10},
			{0, 9}, {0, 10}, {0, 10}, {1, 10},
		},
		{
			{0, 0}, {10, 0}, {10, 0}, {10, 4},
			{9, 0}, {10, 0}, {10, 0}, {10, 1},
		},
		{
			{0, 0}, {0, 9.5}, {0.5, 10}, {4, 10},
			{0, 9}, {0, 9.5}, {0.5, 10}, {1, 10},
		},
	}
	same := func(a, b Point) bool {
		if math.Abs(a.X-b.X) > Zeroish {
			return false
		}
		if math.Abs(a.Y-b.Y) > Zeroish {
			return false
		}
		return true
	}
	rt := math.Sqrt(2)
	for i, v := range ts {
		hit, a, b, c, d := Narrows(v[0], v[1], v[2], v[3], rt)
		want := len(v) == 8
		if hit == want {
			if !want {
				continue
			}
		}
		if same(a, v[4]) && same(b, v[5]) && same(c, v[6]) && same(d, v[7]) {
			continue
		}
		t.Errorf("%d got %v [%v %v %v %v] want %v %v", i, hit, a, b, c, d, want, v[4:])
	}
}

func TestSlice(t *testing.T) {
	var s *Shapes
	s = s.Builder([]Point{{1, 1}, {2, 1}, {2, 2}, {1, 2}}...)
	lines, err := s.Slice(0, 0.2)
	if err != nil {
		t.Fatalf("failed to slice: %v", err)
	}
	want := []Line{
		{Point{1.1, 1.1}, Point{1.9, 1.1}},
		{Point{1.1, 1.2}, Point{1.9, 1.2}},
		{Point{1.1, 1.3}, Point{1.9, 1.3}},
		{Point{1.1, 1.4}, Point{1.9, 1.4}},
		{Point{1.1, 1.5}, Point{1.9, 1.5}},
		{Point{1.1, 1.6}, Point{1.9, 1.6}},
		{Point{1.1, 1.7}, Point{1.9, 1.7}},
		{Point{1.1, 1.8}, Point{1.9, 1.8}},
		{Point{1.1, 1.9}, Point{1.9, 1.9}},
	}
	if len(lines) != len(want) {
		t.Fatalf("got %d lines, wanted %d: %v, got: %v", len(lines), len(want), want, lines)
	}
	for i, line := range lines {
		w := want[i]
		if MatchPoint(w.From, line.From) && MatchPoint(w.To, line.To) {
			continue
		}
		t.Errorf("line[%d] got=%v, want=%v", i, line, w)
	}
	OptimizeLines(lines)
	for i, line := range lines {
		w := want[i]
		if i&1 != 0 {
			// Invert the direction because this is a
			// more optimal path.
			w.From, w.To = w.To, w.From
		}
		if MatchPoint(w.From, line.From) && MatchPoint(w.To, line.To) {
			continue
		}
		t.Errorf("line[%d] got=%v, want=%v", i, line, w)
	}

	lines, err = s.VSlice(0, 0.2)
	if err != nil {
		t.Fatalf("failed to slice: %v", err)
	}
	want = []Line{
		{Point{1.1, 1.1}, Point{1.1, 1.9}},
		{Point{1.2, 1.1}, Point{1.2, 1.9}},
		{Point{1.3, 1.1}, Point{1.3, 1.9}},
		{Point{1.4, 1.1}, Point{1.4, 1.9}},
		{Point{1.5, 1.1}, Point{1.5, 1.9}},
		{Point{1.6, 1.1}, Point{1.6, 1.9}},
		{Point{1.7, 1.1}, Point{1.7, 1.9}},
		{Point{1.8, 1.1}, Point{1.8, 1.9}},
		{Point{1.9, 1.1}, Point{1.9, 1.9}},
	}
	if len(lines) != len(want) {
		t.Fatalf("got %d lines, wanted %d: %v, got: %v", len(lines), len(want), want, lines)
	}
	for i, line := range lines {
		w := want[i]
		if MatchPoint(w.From, line.From) && MatchPoint(w.To, line.To) {
			continue
		}
		t.Errorf("line[%d] got=%v, want=%v", i, line, w)
	}

	s = nil
	s = s.Builder([]Point{{1, 1}, {1.4, 1}, {1.4, 1.4}, {1.6, 1.4}, {1.6, 1}, {2, 1}, {2, 2}, {1, 2}}...)
	lines, err = s.Slice(0, 0.2)
	if err != nil {
		t.Fatalf("failed to slice: %v", err)
	}
	if len(lines) != 12 {
		for i, line := range lines {
			t.Errorf("[%d] %v", i, line)
		}
		t.Fatalf("got %d lines, wanted %d", len(lines), 13)
	}

	s = nil
	s = s.Builder([]Point{
		{91.861, 64.235},
		{91.894, 64.169},
		{91.960, 64.136},
		{94.639, 64.136},
		{94.705, 64.169},
		{94.738, 64.235},
		{94.738, 66.854},
		{94.705, 66.920},
		{94.639, 66.953},
		{91.960, 66.953},
		{91.894, 66.920},
		{91.861, 66.854},
	}...).Builder([]Point{
		{92.078, 64.353},
		{92.078, 66.736},
		{94.521, 66.736},
		{94.521, 64.353},
	}...)
	lines, err = s.Slice(0, 0.05, 1)
	if err != nil {
		t.Errorf("slicing: %v", err)
	}
	if got, want := len(lines), 207; got != want {
		t.Errorf("slice generated bad lines: got=%d want=%d", got, want)
	}
}

func TestInnards(t *testing.T) {
	vs := []string{
		"########",
		" #     #",
		" # ### # ",
		"## # # #",
		"#  ### #",
		"##     #",
		"########",
	}
	for rev := 0; rev < 2; rev++ {
		p := &Shapes{}
		for i := 0; i < len(vs); i++ {
			index := len(vs) - 1 - i
			if rev == 1 {
				index = i
			}
			line := vs[i]
			y := float64(index)
			for j := 0; j < len(line); j++ {
				if line[j] != '#' {
					continue
				}
				x := float64(j)
				p = p.Builder([]Point{
					{x, y}, {x + 1, y}, {x + 1, y + 1}, {x, y + 1},
				}...)
			}
		}
		p.Union()
		if got, want := len(p.P), 4; got != want {
			t.Errorf("wrong number of polygons: got=%d want=%d", got, want)
		}
		for i, s := range p.P {
			if s.Hole != (i%2 == 1) {
				t.Errorf("%d should be a hole=%v", i, !s.Hole)
			}
		}
	}
}

func TestTransform(t *testing.T) {
	var s *Shapes
	s = s.Builder([]Point{{1, 1}, {3, 1}, {3, 2}, {1, 2}}...)
	r := s.Transform(Point{1, 2}, Point{3, 1}, math.Pi, 1)
	if r == nil || len(r.P) != 1 {
		t.Fatalf("single shape expected got something else: %#v", r)
	}
	for i, p := range s.P {
		c := r.P[i]
		if len(c.PS) != len(p.PS) {
			t.Errorf("shape=%d does not match: got=%#v want=%#v", i, p, c)
		}
		for j, pt := range p.PS {
			d := c.PS[j]
			if !MatchPoint(pt, d) {
				t.Errorf("transformed point[%d,%d] got=%v want=%v", i, j, pt, d)
			}
		}

	}
}
